"use strict";var offlineMapData=(()=>{var X=Object.defineProperty;var _t=Object.getOwnPropertyDescriptor;var Lt=Object.getOwnPropertyNames;var Nt=Object.prototype.hasOwnProperty;var Mt=(t,e)=>{for(var n in e)X(t,n,{get:e[n],enumerable:!0})},Gt=(t,e,n,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let o of Lt(e))!Nt.call(t,o)&&o!==n&&X(t,o,{get:()=>e[o],enumerable:!(r=_t(e,o))||r.enumerable});return t};var Ct=t=>Gt(X({},"__esModule",{value:!0}),t);var ee={};Mt(ee,{abortAllDownloads:()=>A,abortDownload:()=>L,default:()=>te,deleteAllFiles:()=>ut,deleteFile:()=>H,emit:()=>u,getAllStatus:()=>it,getStatus:()=>st,getStorageEstimate:()=>h,isDownloading:()=>ot,isMonitoring:()=>j,isOnline:()=>O,isPersistentStorage:()=>Z,isReady:()=>lt,off:()=>P,on:()=>C,once:()=>K,registerFile:()=>z,registerFiles:()=>at,requestPersistentStorage:()=>V,retrieve:()=>It,retryFailed:()=>nt,startDownloads:()=>et,startMonitoring:()=>rt,stopDownloads:()=>Y,stopMonitoring:()=>q,updateConnectivityStatus:()=>tt,updateRegistryMetadata:()=>Tt});var ft="offline-data-manager",pt=1,M=null,i={REGISTRY:"registry",DOWNLOAD_QUEUE:"downloadQueue"};async function mt(t,e){ft=t??"offline-data-manager",pt=e??1}async function I(){return M||(M=await new Promise((t,e)=>{let n=indexedDB.open(ft,pt);n.onupgradeneeded=r=>{let o=r.target.result;if(!o.objectStoreNames.contains(i.REGISTRY)){let a=o.createObjectStore(i.REGISTRY,{keyPath:"id"});a.createIndex("protected","protected",{unique:!1}),a.createIndex("priority","priority",{unique:!1})}if(!o.objectStoreNames.contains(i.DOWNLOAD_QUEUE)){let a=o.createObjectStore(i.DOWNLOAD_QUEUE,{keyPath:"id"});a.createIndex("status","status",{unique:!1}),a.createIndex("priority","priority",{unique:!1})}},n.onsuccess=()=>t(n.result),n.onerror=()=>e(n.error)}),M)}async function f(t,e){let n=await I();return new Promise((r,o)=>{let a=n.transaction(t,"readonly").objectStore(t).get(e);a.onsuccess=()=>r(a.result),a.onerror=()=>o(a.error)})}async function D(t){let e=await I();return new Promise((n,r)=>{let o=e.transaction(t,"readonly").objectStore(t).getAll();o.onsuccess=()=>n(o.result),o.onerror=()=>r(o.error)})}async function G(t){let e=await I();return new Promise((n,r)=>{let o=e.transaction(t,"readonly").objectStore(t).getAllKeys();o.onsuccess=()=>n(o.result),o.onerror=()=>r(o.error)})}async function w(t,e){let n=await I();return new Promise((r,o)=>{let a=n.transaction(t,"readwrite").objectStore(t).put(e);a.onsuccess=()=>r(),a.onerror=()=>o(a.error),a.onerror=()=>o(a.error)})}async function S(t,e){let n=await I();return new Promise((r,o)=>{let a=n.transaction(t,"readwrite").objectStore(t).delete(e);a.onsuccess=()=>r(),a.onerror=()=>o(a.error)})}var U=new Map;function C(t,e){return U.has(t)||U.set(t,new Set),U.get(t).add(e),()=>P(t,e)}function P(t,e){U.get(t)?.delete(e)}function u(t,e){U.get(t)?.forEach(n=>{try{n(e)}catch(r){console.error(`[offline-data-manager] Error in "${t}" listener:`,r)}})}function K(t,e){let n=r=>{e(r),P(t,n)};C(t,n)}async function h(){if(!navigator?.storage?.estimate)return{usage:0,quota:1/0,available:1/0};let{usage:t=0,quota:e=1/0}=await navigator.storage.estimate();return{usage:t,quota:e,available:e-t}}async function wt(t){let{available:e,quota:n}=await h();return e-n*.1>=t}async function V(){return navigator?.storage?.persist?navigator.storage.persist():!1}async function Z(){return navigator?.storage?.persisted?navigator.storage.persisted():!1}function Q(t){return t===1/0?"\u221E":t<1024?`${t} B`:t<1024**2?`${(t/1024).toFixed(1)} KB`:t<1024**3?`${(t/1024**2).toFixed(1)} MB`:`${(t/1024**3).toFixed(2)} GB`}var B=null,F=null,_=!1,J=!0;function gt(){u("connectivity",{online:!1}),B?.()}function yt(){u("connectivity",{online:!0}),F?.()}function Et({pauseAll:t,resumeAll:e}){_||(B=t,F=e,window&&(window.addEventListener("offline",gt),window.addEventListener("online",yt)),_=!0)}function q(){globalThis.window&&(window.removeEventListener("offline",gt),window.removeEventListener("online",yt)),B=null,F=null,_=!1}function O(){return globalThis.window?navigator.onLine??!0:J}function j(){return _}function tt(t){J=t,_&&(J?F?.():B?.())}var Qt={png:"image/png",jpg:"image/jpeg",jpeg:"image/jpeg",webp:"image/webp",svg:"image/svg+xml",ico:"image/x-icon",bmp:"image/bmp",gif:"image/gif",tif:"image/tiff",tiff:"image/tiff",avif:"image/avif",apng:"image/apng",mp4:"video/mp4",webm:"video/webm",mpeg:"video/mpeg",mp3:"audio/mpeg",wav:"audio/wav",ttf:"font/ttf",woff:"font/woff",woff2:"font/woff2",otf:"font/otf",json:"application/json",geojson:"application/json",geojsonseq:"application/json",topojson:"application/json",gpx:"application/xml",georss:"application/xml",gml:"application/xml",citygml:"application/xml",czml:"application/xml",xml:"application/xml",kml:"application/vnd.google-earth.kml+xml",xls:"application/vnd.ms-excel",xlsx:"application/vnd.ms-excel",gltf:"model/gltf+json",glb:"model/gltf-binary",dae:"model/vnd.collada+xml",zip:"application/zip",pbf:"application/x-protobuf",mvt:"application/vnd.mapbox-vector-tile",pdf:"application/pdf",terrian:"application/vnd.quantized-mesh",pmtiles:"application/vnd.pmtiles",htm:"text/html",html:"text/html",xhtml:"application/xhtml+xml",js:"text/javascript",css:"text/css",csv:"text/csv",md:"text/markdown",plain:"text/plain",txt:"text/plain",wat:"text/plain",wsv:"text/wsv",wasm:"application/wasm"};function Dt(t){if(t&&typeof t=="string"&&t.includes(".")){let e=t.split(".").pop().toLowerCase(),n=Qt[e];if(n)return n}return"application/octet-stream"}var Bt=2*1024*1024,Ft=5*1024*1024,qt=2,Rt=5,jt=1e3,y=new Map,b=!1,W=null;function xt(){return new Promise(t=>{W=t})}function T(){if(W){let t=W;W=null,t()}}var Wt=t=>new Promise(e=>setTimeout(e,t)),Yt=t=>jt*Math.pow(2,t);async function g(t,e){let n=await f(i.DOWNLOAD_QUEUE,t);if(!n)return;await w(i.DOWNLOAD_QUEUE,{...n,...e});let{data:r,...o}=e;Object.keys(o).length>0&&await k(t,o)}async function kt(t,e){try{let n=await fetch(t,{method:"HEAD",signal:e}),r=n.headers.get("Accept-Ranges")==="bytes",o=n.headers.get("Content-Encoding"),a=!!o&&o!=="identity",d=n.headers.get("Content-Length"),s=d&&!a?parseInt(d,10):null,c=bt(n.headers.get("Content-Type"));return{supportsRange:r,totalBytes:s,mimeType:c}}catch{return{supportsRange:!1,totalBytes:null,mimeType:null}}}function bt(t){return t&&t.split(";")[0].trim()||null}function At(t){let e=t.reduce((o,a)=>o+a.byteLength,0),n=new Uint8Array(e),r=0;for(let o of t)n.set(o,r),r+=o.byteLength;return n}async function $t(t){let{id:e,downloadUrl:n,ttl:r}=t,o=new AbortController;y.set(e,o);let a=await f(i.DOWNLOAD_QUEUE,e),d=a?.retryCount??0;for(;d<=Rt;)try{await g(e,{status:l.IN_PROGRESS,lastAttemptAt:Date.now(),retryCount:d,errorMessage:null}),u("status",{id:e,status:l.IN_PROGRESS}),a=await f(i.DOWNLOAD_QUEUE,e);let s=a?.byteOffset??0,c=!1,p=a?.totalBytes??t.totalBytes??null,m=t.mimeType??null;if(s===0){let x=await kt(n,o.signal);c=x.supportsRange,x.totalBytes&&(p=x.totalBytes,await g(e,{totalBytes:p})),!m&&x.mimeType&&(m=x.mimeType)}else c=!0;let E=c&&p&&p>Ft,R,v=null;if(E)R=await Ht(e,n,s,p,o.signal);else{let x=await zt(e,n,o.signal);R=x.uint8,v=x.mimeType}let Ut=Dt(n),dt=m??v??Ut,N=R.buffer,ct=Date.now(),Pt=St(ct,r);await g(e,{status:l.COMPLETE,data:N,mimeType:dt,bytesDownloaded:N.byteLength,byteOffset:N.byteLength,storedBytes:N?.byteLength,completedAt:ct,expiresAt:Pt,errorMessage:null,deferredReason:null}),u("complete",{id:e,mimeType:dt}),y.delete(e);return}catch(s){if(s?.name==="QuotaExceededError"){await Y(),await g(e,{status:l.DEFERRED,deferredReason:"insufficient-storage"}),u("error",{id:e,reason:"insufficient-storage",willRetry:!1});return}else if(s?.name==="AbortError"){await g(e,{status:l.PAUSED}),u("status",{id:e,status:l.PAUSED}),y.delete(e);return}if(d++,d>Rt){await g(e,{status:l.FAILED,retryCount:d,errorMessage:s.message}),u("error",{id:e,error:s,retryCount:d}),y.delete(e);return}let c=Yt(d-1);console.warn(`[offline-data-manager] "${e}" failed (attempt ${d}), retrying in ${c}ms:`,s.message),u("error",{id:e,error:s,retryCount:d,willRetry:!0}),await g(e,{status:l.PENDING,retryCount:d,errorMessage:s.message}),await Wt(c)}}async function zt(t,e,n){let r=await fetch(e,{signal:n});if(!r.ok)throw new Error(`HTTP ${r.status} ${r.statusText}`);let o=r.headers.get("Content-Encoding"),a=!!o&&o!=="identity",d=r.headers.get("Content-Length"),s=d&&!a?parseInt(d,10):null,c=bt(r.headers.get("Content-Type")),p=r.body.getReader(),m=[],E=0;for(;;){let{done:R,value:v}=await p.read();if(R)break;m.push(v),E+=v.byteLength,await g(t,{bytesDownloaded:E,totalBytes:s}),u("progress",{id:t,bytesDownloaded:E,totalBytes:s,percent:s?Math.round(E/s*100):null})}return{uint8:At(m),mimeType:c}}async function Ht(t,e,n,r,o){let a=n,d=[],s=n;for(;a<r;){let c=Math.min(a+Bt-1,r-1),p=await fetch(e,{signal:o,headers:{Range:`bytes=${a}-${c}`}});if(!p.ok&&p.status!==206)throw new Error(`HTTP ${p.status} on Range bytes=${a}-${c}`);let m=new Uint8Array(await p.arrayBuffer());d.push(m),a+=m.byteLength,s+=m.byteLength,await g(t,{bytesDownloaded:s,byteOffset:a}),u("progress",{id:t,bytesDownloaded:s,totalBytes:r,percent:Math.round(s/r*100)})}return At(d)}async function Xt(t){await ht();let[e,n]=await Promise.all([D(i.REGISTRY),D(i.DOWNLOAD_QUEUE)]),r=new Map(e.map(s=>[s.id,s])),o=n.filter(s=>[l.PENDING,l.IN_PROGRESS,l.PAUSED,l.DEFERRED,l.EXPIRED].includes(s.status)).sort((s,c)=>(r.get(s.id)?.priority??10)-(r.get(c.id)?.priority??10));if(o.length===0)return;let a=[...o],d=new Set;await new Promise(s=>{function c(){if(!b){s();return}if(a.length===0){d.size===0&&s();return}if(d.size>=t)return;let p=a.shift(),m=r.get(p.id);if(!m){c();return}let E=(async()=>{let R=m.totalBytes??p.totalBytes??0;if(R>0&&!await wt(R)){await g(p.id,{status:l.DEFERRED,deferredReason:"insufficient-storage"}),u("deferred",{id:p.id,reason:"insufficient-storage"});return}await $t(m)})().finally(()=>{d.delete(E),c()});d.add(E),c()}c()})}function et({concurrency:t=qt}={}){b||(b=!0,(async()=>{for(;b;){if(!O()){let e=await D(i.DOWNLOAD_QUEUE);for(let n of e)n.status===l.IN_PROGRESS&&(y.get(n.id)?.abort(),y.delete(n.id),await g(n.id,{status:l.PAUSED,deferredReason:"network-offline"}));u("connectivity",{online:!1}),await xt();continue}await Xt(t),b&&await xt()}})())}async function Y(){b=!1,T(),await A(),u("stopped",{})}async function nt(){let t=await D(i.DOWNLOAD_QUEUE);for(let e of t)e.status===l.FAILED&&await g(e.id,{status:l.PENDING,retryCount:0,errorMessage:null});T()}function ot(){return b}async function L(t){y.get(t)?.abort(),y.delete(t)}async function A(){for(let[t,e]of y)e.abort(),y.delete(t)}function rt(){Et({pauseAll:A,resumeAll:T})}var l={PENDING:"pending",IN_PROGRESS:"in-progress",PAUSED:"paused",COMPLETE:"complete",EXPIRED:"expired",FAILED:"failed",DEFERRED:"deferred"},$=new Set([l.COMPLETE,l.EXPIRED]);function Kt(t){if(!t||typeof t!="object")throw new Error("Registry entry must be an object.");if(!t.id||typeof t.id!="string")throw new Error('Registry entry must have a string "id".');if(!t.downloadUrl||typeof t.downloadUrl!="string")throw new Error(`Entry "${t.id}" must have a string "downloadUrl".`);if(t.mimeType!==void 0&&t.mimeType!==null&&typeof t.mimeType!="string")throw new Error(`Entry "${t.id}" mimeType must be a string or omitted.`);if(typeof t.version!="number"||!Number.isInteger(t.version)||t.version<0)throw new Error(`Entry "${t.id}" version must be a non-negative integer.`);if(t.ttl!==void 0&&(typeof t.ttl!="number"||t.ttl<0))throw new Error(`Entry "${t.id}" ttl must be a non-negative number (seconds).`)}function Ot(t){return{id:t,status:l.PENDING,data:null,bytesDownloaded:0,totalBytes:null,byteOffset:0,retryCount:0,lastAttemptAt:null,errorMessage:null,deferredReason:null,completedAt:null,expiresAt:null}}async function k(t,e){let n=await f(i.REGISTRY,t);n&&await w(i.REGISTRY,{...n,...e})}function St(t,e){return e?t+e*1e3:null}function Vt(t){return t?Date.now()>=t:!1}async function z(t){try{Kt(t);let e=Date.now(),n=await f(i.REGISTRY,t.id),r=await f(i.DOWNLOAD_QUEUE,t.id),o={id:t.id,downloadUrl:t.downloadUrl,mimeType:t.mimeType??null,version:t.version,protected:t.protected??!1,priority:t.priority??10,ttl:t.ttl??0,totalBytes:t.totalBytes??null,metadata:t.metadata??{},registeredAt:n?.registeredAt??e,updatedAt:e,...n?{}:{status:l.PENDING,bytesDownloaded:0,retryCount:0,lastAttemptAt:null,errorMessage:null,deferredReason:null,completedAt:null,expiresAt:null}};if(n){if(t.version>n.version){await w(i.REGISTRY,o);let a=r?{...r,status:l.PENDING,bytesDownloaded:0,byteOffset:0,retryCount:0,errorMessage:null,deferredReason:null,completedAt:null,expiresAt:null}:Ot(t.id);await w(i.DOWNLOAD_QUEUE,a),await k(t.id,{status:l.PENDING,bytesDownloaded:0,retryCount:0,errorMessage:null,deferredReason:null,completedAt:null,expiresAt:null}),u("registered",{id:t.id,reason:"version-updated"}),T()}return}await w(i.REGISTRY,o),await w(i.DOWNLOAD_QUEUE,Ot(t.id)),u("registered",{id:t.id,reason:"new"}),T()}catch(e){if(e?.name==="QuotaExceededError"){u("error",{id,reason:"insufficient-storage",willRetry:!1});return}else u("error",{id,reason:e?.message??e,willRetry:!1})}}async function at(t){if(!Array.isArray(t))throw new Error("registerFiles expects an array.");let e=new Set(t.map(o=>o.id)),n=await D(i.REGISTRY),r=[];for(let o of n)!e.has(o.id)&&!o.protected&&(await S(i.REGISTRY,o.id),await S(i.DOWNLOAD_QUEUE,o.id),r.push(o.id),u("deleted",{id:o.id,registryRemoved:!0}));for(let o of t)await z(o);return{registered:t.map(o=>o.id),removed:r}}async function Tt(t,e){try{if(t&&e){let n=await f(i.REGISTRY,entry.id);n&&(n.metadata={...n.metadata??{},...e},await w(i.REGISTRY,n))}}catch(n){if(n?.name==="QuotaExceededError"){u("error",{id:t,reason:"insufficient-storage",willRetry:!1});return}else u("error",{id:t,reason:n?.message??n,willRetry:!1})}}async function ht(){let t=await D(i.DOWNLOAD_QUEUE),e=[];for(let n of t)n.status===l.COMPLETE&&Vt(n.expiresAt)&&(await w(i.DOWNLOAD_QUEUE,{...n,status:l.EXPIRED}),await k(n.id,{status:l.EXPIRED}),e.push(n.id),u("expired",{id:n.id}));return e}async function it(){let[t,e]=await Promise.all([D(i.REGISTRY),h()]);return{items:t.map(r=>vt(r)).sort((r,o)=>r.priority-o.priority),storage:{usageBytes:e.usage,quotaBytes:e.quota,availableBytes:e.available,usageFormatted:Q(e.usage),quotaFormatted:Q(e.quota),availableFormatted:Q(e.available)}}}async function st(t){let e=await f(i.REGISTRY,t);return e?vt(e):null}function vt(t){return{id:t.id,downloadUrl:t.downloadUrl,mimeType:t.mimeType??null,version:t.version,protected:t.protected,priority:t.priority,ttl:t.ttl,totalBytes:t.totalBytes,metadata:t.metadata,registeredAt:t.registeredAt,updatedAt:t.updatedAt,downloadStatus:t.status??null,bytesDownloaded:t.bytesDownloaded??0,progress:t.totalBytes&&t.bytesDownloaded?Math.round(t.bytesDownloaded/t.totalBytes*100):null,retryCount:t.retryCount??0,lastAttemptAt:t.lastAttemptAt??null,errorMessage:t.errorMessage??null,deferredReason:t.deferredReason??null,completedAt:t.completedAt??null,expiresAt:t.expiresAt??null}}async function lt(t){let e=await f(i.REGISTRY,t);if(e?.status)return $.has(e?.status);let n=await f(i.DOWNLOAD_QUEUE,t);return $.has(n?.status)}async function Zt(t){let e=await f(i.DOWNLOAD_QUEUE,t);e&&await w(i.DOWNLOAD_QUEUE,{...e,status:l.PENDING,data:null,bytesDownloaded:0,byteOffset:0,retryCount:0,errorMessage:null,deferredReason:null,completedAt:null,expiresAt:null})}async function H(t,{removeProtected:e=!1}={}){let n=await f(i.REGISTRY,t);if(!n)throw new Error(`deleteFile: No registered file with id "${t}".`);await L(t);let r=e||!n.protected;return r?(await S(i.REGISTRY,t),await S(i.DOWNLOAD_QUEUE,t)):await Zt(t),u("deleted",{id:t,registryRemoved:r}),{id:t,registryRemoved:r}}async function ut({removeProtected:t=!1}={}){await A();let e=await G(i.REGISTRY);return Promise.all(e.map(n=>H(n,{removeProtected:t})))}async function It(t){let[e,n]=await Promise.all([f(i.REGISTRY,t),f(i.DOWNLOAD_QUEUE,t)]);if(!e)throw new Error(`retrieve: No registered file with id "${t}".`);if(!$.has(n?.status)||!n?.data)throw new Error(`retrieve: File "${t}" has no data yet (status: ${n?.status??"unknown"}).`);return{data:n.data,mimeType:n.mimeType}}var Jt={setDBInfo:mt,dbGetAllIds:G,registerFile:z,registerFiles:at,startDownloads:et,stopDownloads:Y,retryFailed:nt,isDownloading:ot,abortDownload:L,abortAllDownloads:A,startMonitoring:rt,stopMonitoring:q,isOnline:O,isMonitoring:j,updateConnectivityStatus:tt,retrieve:It,getAllStatus:it,getStatus:st,isReady:lt,delete:H,deleteAll:ut,on:C,off:P,once:K,getStorageEstimate:h,requestPersistentStorage:V,isPersistentStorage:Z},te=Jt;return Ct(ee);})();
