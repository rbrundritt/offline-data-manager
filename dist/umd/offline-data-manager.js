"use strict";var offlineMapData=(()=>{var H=Object.defineProperty;var Ue=Object.getOwnPropertyDescriptor;var Ie=Object.getOwnPropertyNames;var ve=Object.prototype.hasOwnProperty;var _e=(e,t)=>{for(var r in t)H(e,r,{get:t[r],enumerable:!0})},Le=(e,t,r,a)=>{if(t&&typeof t=="object"||typeof t=="function")for(let o of Ie(t))!ve.call(e,o)&&o!==r&&H(e,o,{get:()=>t[o],enumerable:!(a=Ue(t,o))||a.enumerable});return e};var Ne=e=>Le(H({},"__esModule",{value:!0}),e);var ze={};_e(ze,{abortAllDownloads:()=>S,abortDownload:()=>N,default:()=>Ke,deleteAllFiles:()=>le,deleteFile:()=>k,emit:()=>u,getAllStatus:()=>ae,getStatus:()=>ie,getStorageEstimate:()=>O,isDownloading:()=>te,isMonitoring:()=>q,isOnline:()=>x,isPersistentStorage:()=>z,isReady:()=>se,off:()=>_,on:()=>G,once:()=>X,registerFile:()=>Y,registerFiles:()=>ne,requestPersistentStorage:()=>K,retrieve:()=>xe,retryFailed:()=>ee,startDownloads:()=>J,startMonitoring:()=>re,stopDownloads:()=>$,stopMonitoring:()=>F,updateConnectivityStatus:()=>Z,updateRegistryMetadata:()=>Oe});var ce="offline-data-manager",fe=1,P=null,i={REGISTRY:"registry",DOWNLOAD_QUEUE:"downloadQueue"};async function pe(e,t){ce=e??"offline-data-manager",fe=t??1}async function I(){return P||(P=await new Promise((e,t)=>{let r=indexedDB.open(ce,fe);r.onupgradeneeded=a=>{let o=a.target.result;if(!o.objectStoreNames.contains(i.REGISTRY)){let n=o.createObjectStore(i.REGISTRY,{keyPath:"id"});n.createIndex("protected","protected",{unique:!1}),n.createIndex("priority","priority",{unique:!1})}if(!o.objectStoreNames.contains(i.DOWNLOAD_QUEUE)){let n=o.createObjectStore(i.DOWNLOAD_QUEUE,{keyPath:"id"});n.createIndex("status","status",{unique:!1}),n.createIndex("priority","priority",{unique:!1})}},r.onsuccess=()=>e(r.result),r.onerror=()=>t(r.error)}),P)}async function p(e,t){let r=await I();return new Promise((a,o)=>{let n=r.transaction(e,"readonly").objectStore(e).get(t);n.onsuccess=()=>a(n.result),n.onerror=()=>o(n.error)})}async function g(e){let t=await I();return new Promise((r,a)=>{let o=t.transaction(e,"readonly").objectStore(e).getAll();o.onsuccess=()=>r(o.result),o.onerror=()=>a(o.error)})}async function M(e){let t=await I();return new Promise((r,a)=>{let o=t.transaction(e,"readonly").objectStore(e).getAllKeys();o.onsuccess=()=>r(o.result),o.onerror=()=>a(o.error)})}async function y(e,t){let r=await I();return new Promise((a,o)=>{let n=r.transaction(e,"readwrite").objectStore(e).put(t);n.onsuccess=()=>a(),n.onerror=()=>o(n.error),n.onerror=()=>o(n.error)})}async function h(e,t){let r=await I();return new Promise((a,o)=>{let n=r.transaction(e,"readwrite").objectStore(e).delete(t);n.onsuccess=()=>a(),n.onerror=()=>o(n.error)})}var v=new Map;function G(e,t){return v.has(e)||v.set(e,new Set),v.get(e).add(t),()=>_(e,t)}function _(e,t){v.get(e)?.delete(t)}function u(e,t){v.get(e)?.forEach(r=>{try{r(t)}catch(a){console.error(`[offline-data-manager] Error in "${e}" listener:`,a)}})}function X(e,t){let r=a=>{t(a),_(e,r)};G(e,r)}async function O(){if(!navigator?.storage?.estimate)return{usage:0,quota:1/0,available:1/0};let{usage:e=0,quota:t=1/0}=await navigator.storage.estimate();return{usage:e,quota:t,available:t-e}}async function we(e){let{available:t,quota:r}=await O();return t-r*.1>=e}async function K(){return navigator?.storage?.persist?navigator.storage.persist():!1}async function z(){return navigator?.storage?.persisted?navigator.storage.persisted():!1}function B(e){return e===1/0?"\u221E":e<1024?`${e} B`:e<1024**2?`${(e/1024).toFixed(1)} KB`:e<1024**3?`${(e/1024**2).toFixed(1)} MB`:`${(e/1024**3).toFixed(2)} GB`}var C=null,Q=null,L=!1,V=!0;function me(){u("connectivity",{online:!1}),C?.()}function ye(){u("connectivity",{online:!0}),Q?.()}function ge({pauseAll:e,resumeAll:t}){L||(C=e,Q=t,window&&(window.addEventListener("offline",me),window.addEventListener("online",ye)),L=!0)}function F(){globalThis.window&&(window.removeEventListener("offline",me),window.removeEventListener("online",ye)),C=null,Q=null,L=!1}function x(){return globalThis.window?navigator.onLine??!0:V}function q(){return L}function Z(e){V=e,L&&(V?Q?.():C?.())}var Pe=2*1024*1024,Me=5*1024*1024,Ge=2,Ee=5,Be=1e3,E=new Map,b=!1,W=null;function De(){return new Promise(e=>{W=e})}function T(){if(W){let e=W;W=null,e()}}var Ce=e=>new Promise(t=>setTimeout(t,e)),Qe=e=>Be*Math.pow(2,e);async function m(e,t){let r=await p(i.DOWNLOAD_QUEUE,e);r&&await y(i.DOWNLOAD_QUEUE,{...r,...t})}async function Fe(e,t){try{let r=await fetch(e,{method:"HEAD",signal:t}),a=r.headers.get("Accept-Ranges")==="bytes",o=r.headers.get("Content-Encoding"),n=!!o&&o!=="identity",s=r.headers.get("Content-Length"),l=s&&!n?parseInt(s,10):null,c=Ae(r.headers.get("Content-Type"));return{supportsRange:a,totalBytes:l,mimeType:c}}catch{return{supportsRange:!1,totalBytes:null,mimeType:null}}}function Ae(e){return e&&e.split(";")[0].trim()||null}function Re(e){let t=e.reduce((o,n)=>o+n.byteLength,0),r=new Uint8Array(t),a=0;for(let o of e)r.set(o,a),a+=o.byteLength;return r}async function qe(e){let{id:t,downloadUrl:r,ttl:a}=e,o=new AbortController;E.set(t,o);let n=await p(i.DOWNLOAD_QUEUE,t),s=n?.retryCount??0;for(;s<=Ee;)try{await m(t,{status:d.IN_PROGRESS,lastAttemptAt:Date.now(),retryCount:s,errorMessage:null}),u("status",{id:t,status:d.IN_PROGRESS}),n=await p(i.DOWNLOAD_QUEUE,t);let l=n?.byteOffset??0,c=!1,f=n?.totalBytes??e.totalBytes??null,w=e.mimeType??null;if(l===0){let R=await Fe(r,o.signal);c=R.supportsRange,R.totalBytes&&(f=R.totalBytes,await m(t,{totalBytes:f})),!w&&R.mimeType&&(w=R.mimeType)}else c=!0;let D=c&&f&&f>Me,A,U=null;if(D)A=await $e(t,r,l,f,o.signal);else{let R=await We(t,r,o.signal);A=R.uint8,U=R.mimeType}let ue=w??U??"application/octet-stream",j=A.buffer,de=Date.now(),Te=be(de,a);await m(t,{status:d.COMPLETE,data:j,mimeType:ue,bytesDownloaded:j.byteLength,byteOffset:j.byteLength,completedAt:de,expiresAt:Te,errorMessage:null,deferredReason:null}),u("complete",{id:t,mimeType:ue}),E.delete(t);return}catch(l){if(l?.name==="QuotaExceededError"){await $(),await m(t,{status:d.DEFERRED,deferredReason:"insufficient-storage"}),u("error",{id:t,reason:"insufficient-storage",willRetry:!1});return}else if(l?.name==="AbortError"){await m(t,{status:d.PAUSED}),u("status",{id:t,status:d.PAUSED}),E.delete(t);return}if(s++,s>Ee){await m(t,{status:d.FAILED,retryCount:s,errorMessage:l.message}),u("error",{id:t,error:l,retryCount:s}),E.delete(t);return}let c=Qe(s-1);console.warn(`[offline-data-manager] "${t}" failed (attempt ${s}), retrying in ${c}ms:`,l.message),u("error",{id:t,error:l,retryCount:s,willRetry:!0}),await m(t,{status:d.PENDING,retryCount:s,errorMessage:l.message}),await Ce(c)}}async function We(e,t,r){let a=await fetch(t,{signal:r});if(!a.ok)throw new Error(`HTTP ${a.status} ${a.statusText}`);let o=a.headers.get("Content-Encoding"),n=!!o&&o!=="identity",s=a.headers.get("Content-Length"),l=s&&!n?parseInt(s,10):null,c=Ae(a.headers.get("Content-Type")),f=a.body.getReader(),w=[],D=0;for(;;){let{done:A,value:U}=await f.read();if(A)break;w.push(U),D+=U.byteLength,await m(e,{bytesDownloaded:D,totalBytes:l}),u("progress",{id:e,bytesDownloaded:D,totalBytes:l,percent:l?Math.round(D/l*100):null})}return{uint8:Re(w),mimeType:c}}async function $e(e,t,r,a,o){let n=r,s=[],l=r;for(;n<a;){let c=Math.min(n+Pe-1,a-1),f=await fetch(t,{signal:o,headers:{Range:`bytes=${n}-${c}`}});if(!f.ok&&f.status!==206)throw new Error(`HTTP ${f.status} on Range bytes=${n}-${c}`);let w=new Uint8Array(await f.arrayBuffer());s.push(w),n+=w.byteLength,l+=w.byteLength,await m(e,{bytesDownloaded:l,byteOffset:n}),u("progress",{id:e,bytesDownloaded:l,totalBytes:a,percent:Math.round(l/a*100)})}return Re(s)}async function Ye(e){await Se();let[t,r]=await Promise.all([g(i.REGISTRY),g(i.DOWNLOAD_QUEUE)]),a=new Map(t.map(l=>[l.id,l])),o=r.filter(l=>[d.PENDING,d.IN_PROGRESS,d.PAUSED,d.DEFERRED,d.EXPIRED].includes(l.status)).sort((l,c)=>(a.get(l.id)?.priority??10)-(a.get(c.id)?.priority??10));if(o.length===0)return;let n=[...o],s=new Set;await new Promise(l=>{function c(){if(!b){l();return}if(n.length===0){s.size===0&&l();return}if(s.size>=e)return;let f=n.shift(),w=a.get(f.id);if(!w){c();return}let D=(async()=>{let A=w.totalBytes??f.totalBytes??0;if(A>0&&!await we(A)){await m(f.id,{status:d.DEFERRED,deferredReason:"insufficient-storage"}),u("deferred",{id:f.id,reason:"insufficient-storage"});return}await qe(w)})().finally(()=>{s.delete(D),c()});s.add(D),c()}c()})}function J({concurrency:e=Ge}={}){b||(b=!0,(async()=>{for(;b;){if(!x()){let t=await g(i.DOWNLOAD_QUEUE);for(let r of t)r.status===d.IN_PROGRESS&&(E.get(r.id)?.abort(),E.delete(r.id),await m(r.id,{status:d.PAUSED,deferredReason:"network-offline"}));u("connectivity",{online:!1}),await De();continue}await Ye(e),b&&await De()}})())}async function $(){b=!1,T(),await S(),u("stopped",{})}async function ee(){let e=await g(i.DOWNLOAD_QUEUE);for(let t of e)t.status===d.FAILED&&await m(t.id,{status:d.PENDING,retryCount:0,errorMessage:null});T()}function te(){return b}async function N(e){E.get(e)?.abort(),E.delete(e)}async function S(){for(let[e,t]of E)t.abort(),E.delete(e)}function re(){ge({pauseAll:S,resumeAll:T})}var d={PENDING:"pending",IN_PROGRESS:"in-progress",PAUSED:"paused",COMPLETE:"complete",EXPIRED:"expired",FAILED:"failed",DEFERRED:"deferred"},oe=new Set([d.COMPLETE,d.EXPIRED]);function ke(e){if(!e||typeof e!="object")throw new Error("Registry entry must be an object.");if(!e.id||typeof e.id!="string")throw new Error('Registry entry must have a string "id".');if(!e.downloadUrl||typeof e.downloadUrl!="string")throw new Error(`Entry "${e.id}" must have a string "downloadUrl".`);if(e.mimeType!==void 0&&e.mimeType!==null&&typeof e.mimeType!="string")throw new Error(`Entry "${e.id}" mimeType must be a string or omitted.`);if(typeof e.version!="number"||!Number.isInteger(e.version)||e.version<0)throw new Error(`Entry "${e.id}" version must be a non-negative integer.`);if(e.ttl!==void 0&&(typeof e.ttl!="number"||e.ttl<0))throw new Error(`Entry "${e.id}" ttl must be a non-negative number (seconds).`)}function he(e){return{id:e,status:d.PENDING,data:null,bytesDownloaded:0,totalBytes:null,byteOffset:0,retryCount:0,lastAttemptAt:null,errorMessage:null,deferredReason:null,completedAt:null,expiresAt:null}}function be(e,t){return t?e+t*1e3:null}function je(e){return e?Date.now()>=e:!1}async function Y(e){try{ke(e);let t=Date.now(),r=await p(i.REGISTRY,e.id),a=await p(i.DOWNLOAD_QUEUE,e.id),o={id:e.id,downloadUrl:e.downloadUrl,mimeType:e.mimeType??null,version:e.version,protected:e.protected??!1,priority:e.priority??10,ttl:e.ttl??0,totalBytes:e.totalBytes??null,metadata:e.metadata??{},registeredAt:r?.registeredAt??t,updatedAt:t};if(r){if(e.version>r.version){await y(i.REGISTRY,o);let n=a?{...a,status:d.PENDING,bytesDownloaded:0,byteOffset:0,retryCount:0,errorMessage:null,deferredReason:null,completedAt:null,expiresAt:null}:he(e.id);await y(i.DOWNLOAD_QUEUE,n),u("registered",{id:e.id,reason:"version-updated"}),T()}return}await y(i.REGISTRY,o),await y(i.DOWNLOAD_QUEUE,he(e.id)),u("registered",{id:e.id,reason:"new"}),T()}catch(t){if(t?.name==="QuotaExceededError"){u("error",{id,reason:"insufficient-storage",willRetry:!1});return}else u("error",{id,reason:t?.message??t,willRetry:!1})}}async function ne(e){if(!Array.isArray(e))throw new Error("registerFiles expects an array.");let t=new Set(e.map(o=>o.id)),r=await g(i.REGISTRY),a=[];for(let o of r)!t.has(o.id)&&!o.protected&&(await h(i.REGISTRY,o.id),await h(i.DOWNLOAD_QUEUE,o.id),a.push(o.id),u("deleted",{id:o.id,registryRemoved:!0}));for(let o of e)await Y(o);return{registered:e.map(o=>o.id),removed:a}}async function Oe(e,t){try{if(e&&t){let r=await p(i.REGISTRY,entry.id);r&&(r.metadata={...r.metadata??{},...t},await y(i.REGISTRY,r))}}catch(r){if(r?.name==="QuotaExceededError"){u("error",{id:e,reason:"insufficient-storage",willRetry:!1});return}else u("error",{id:e,reason:r?.message??r,willRetry:!1})}}async function Se(){let e=await g(i.DOWNLOAD_QUEUE),t=[];for(let r of e)r.status===d.COMPLETE&&je(r.expiresAt)&&(await y(i.DOWNLOAD_QUEUE,{...r,status:d.EXPIRED}),t.push(r.id),u("expired",{id:r.id}));return t}async function ae(){let[e,t,r]=await Promise.all([g(i.REGISTRY),g(i.DOWNLOAD_QUEUE),O()]),a=new Map(t.map(n=>[n.id,n]));return{items:e.map(n=>{let s=a.get(n.id)??null;return{id:n.id,downloadUrl:n.downloadUrl,mimeType:n.mimeType,version:n.version,protected:n.protected,priority:n.priority,ttl:n.ttl,totalBytes:n.totalBytes,metadata:n.metadata,registeredAt:n.registeredAt,updatedAt:n.updatedAt,downloadStatus:s?.status??null,bytesDownloaded:s?.bytesDownloaded??0,storedBytes:s?.data?.length??null,progress:s?.totalBytes&&s?.bytesDownloaded?Math.round(s.bytesDownloaded/s.totalBytes*100):null,retryCount:s?.retryCount??0,lastAttemptAt:s?.lastAttemptAt??null,errorMessage:s?.errorMessage??null,deferredReason:s?.deferredReason??null,completedAt:s?.completedAt??null,expiresAt:s?.expiresAt??null}}).sort((n,s)=>n.priority-s.priority),storage:{usageBytes:r.usage,quotaBytes:r.quota,availableBytes:r.available,usageFormatted:B(r.usage),quotaFormatted:B(r.quota),availableFormatted:B(r.available)}}}async function ie(e){let[t,r]=await Promise.all([p(i.REGISTRY,e),p(i.DOWNLOAD_QUEUE,e)]);return t?{id:t.id,downloadUrl:t.downloadUrl,mimeType:t.mimeType??null,version:t.version,protected:t.protected,priority:t.priority,ttl:t.ttl,totalBytes:t.totalBytes,metadata:t.metadata,registeredAt:t.registeredAt,updatedAt:t.updatedAt,downloadStatus:r?.status??null,bytesDownloaded:r?.bytesDownloaded??0,storedBytes:r?.data?.length??null,progress:r?.totalBytes&&r?.bytesDownloaded?Math.round(r.bytesDownloaded/r.totalBytes*100):null,retryCount:r?.retryCount??0,lastAttemptAt:r?.lastAttemptAt??null,errorMessage:r?.errorMessage??null,deferredReason:r?.deferredReason??null,completedAt:r?.completedAt??null,expiresAt:r?.expiresAt??null}:null}async function se(e){let t=await p(i.DOWNLOAD_QUEUE,e);return oe.has(t?.status)}async function He(e){let t=await p(i.DOWNLOAD_QUEUE,e);t&&await y(i.DOWNLOAD_QUEUE,{...t,status:d.PENDING,data:null,bytesDownloaded:0,byteOffset:0,retryCount:0,errorMessage:null,deferredReason:null,completedAt:null,expiresAt:null})}async function k(e,{removeProtected:t=!1}={}){let r=await p(i.REGISTRY,e);if(!r)throw new Error(`deleteFile: No registered file with id "${e}".`);await N(e);let a=t||!r.protected;return a?(await h(i.REGISTRY,e),await h(i.DOWNLOAD_QUEUE,e)):await He(e),u("deleted",{id:e,registryRemoved:a}),{id:e,registryRemoved:a}}async function le({removeProtected:e=!1}={}){await S();let t=await M(i.REGISTRY);return Promise.all(t.map(r=>k(r,{removeProtected:e})))}async function xe(e){let[t,r]=await Promise.all([p(i.REGISTRY,e),p(i.DOWNLOAD_QUEUE,e)]);if(!t)throw new Error(`retrieve: No registered file with id "${e}".`);if(!oe.has(r?.status)||!r?.data)throw new Error(`retrieve: File "${e}" has no data yet (status: ${r?.status??"unknown"}).`);return{data:r.data,mimeType:r.mimeType}}var Xe={setDBInfo:pe,dbGetAllIds:M,registerFile:Y,registerFiles:ne,startDownloads:J,stopDownloads:$,retryFailed:ee,isDownloading:te,abortDownload:N,abortAllDownloads:S,startMonitoring:re,stopMonitoring:F,isOnline:x,isMonitoring:q,updateConnectivityStatus:Z,retrieve:xe,getAllStatus:ae,getStatus:ie,isReady:se,delete:k,deleteAll:le,on:G,off:_,once:X,getStorageEstimate:O,requestPersistentStorage:K,isPersistentStorage:z},Ke=Xe;return Ne(ze);})();
