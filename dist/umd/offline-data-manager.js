"use strict";var offlineMapData=(()=>{var K=Object.defineProperty;var Nt=Object.getOwnPropertyDescriptor;var vt=Object.getOwnPropertyNames;var Pt=Object.prototype.hasOwnProperty;var _t=(t,e)=>{for(var r in e)K(t,r,{get:e[r],enumerable:!0})},Lt=(t,e,r,o)=>{if(e&&typeof e=="object"||typeof e=="function")for(let n of vt(e))!Pt.call(t,n)&&n!==r&&K(t,n,{get:()=>e[n],enumerable:!(o=Nt(e,n))||o.enumerable});return t};var Gt=t=>Lt(K({},"__esModule",{value:!0}),t);var Zt={};_t(Zt,{abortAllDownloads:()=>S,abortDownload:()=>_,default:()=>Vt,deleteAllFiles:()=>ut,deleteFile:()=>X,emit:()=>u,getAllStatus:()=>st,getStatus:()=>it,getStorageEstimate:()=>x,isDownloading:()=>nt,isMonitoring:()=>q,isOnline:()=>O,isPersistentStorage:()=>Z,isReady:()=>lt,off:()=>v,on:()=>C,once:()=>z,registerFile:()=>H,registerFiles:()=>at,requestPersistentStorage:()=>V,retrieve:()=>Ut,retryFailed:()=>rt,startDownloads:()=>et,startMonitoring:()=>ot,stopDownloads:()=>$,stopMonitoring:()=>W,updateConnectivityStatus:()=>tt,updateRegistryMetadata:()=>Ot});var ft="offline-data-manager",pt=1,G=null,s={REGISTRY:"registry",DOWNLOAD_QUEUE:"downloadQueue"};async function wt(t,e){ft=t??"offline-data-manager",pt=e??1}async function I(){return G||(G=await new Promise((t,e)=>{let r=indexedDB.open(ft,pt);r.onupgradeneeded=o=>{let n=o.target.result;if(!n.objectStoreNames.contains(s.REGISTRY)){let a=n.createObjectStore(s.REGISTRY,{keyPath:"id"});a.createIndex("protected","protected",{unique:!1}),a.createIndex("priority","priority",{unique:!1})}if(!n.objectStoreNames.contains(s.DOWNLOAD_QUEUE)){let a=n.createObjectStore(s.DOWNLOAD_QUEUE,{keyPath:"id"});a.createIndex("status","status",{unique:!1}),a.createIndex("priority","priority",{unique:!1})}},r.onsuccess=()=>t(r.result),r.onerror=()=>e(r.error)}),G)}async function f(t,e){let r=await I();return new Promise((o,n)=>{let a=r.transaction(t,"readonly").objectStore(t).get(e);a.onsuccess=()=>o(a.result),a.onerror=()=>n(a.error)})}async function D(t){let e=await I();return new Promise((r,o)=>{let n=e.transaction(t,"readonly").objectStore(t).getAll();n.onsuccess=()=>r(n.result),n.onerror=()=>o(n.error)})}async function M(t){let e=await I();return new Promise((r,o)=>{let n=e.transaction(t,"readonly").objectStore(t).getAllKeys();n.onsuccess=()=>r(n.result),n.onerror=()=>o(n.error)})}async function m(t,e){let r=await I();return new Promise((o,n)=>{let a=r.transaction(t,"readwrite").objectStore(t).put(e);a.onsuccess=()=>o(),a.onerror=()=>n(a.error),a.onerror=()=>n(a.error)})}async function h(t,e){let r=await I();return new Promise((o,n)=>{let a=r.transaction(t,"readwrite").objectStore(t).delete(e);a.onsuccess=()=>o(),a.onerror=()=>n(a.error)})}var N=new Map;function C(t,e){return N.has(t)||N.set(t,new Set),N.get(t).add(e),()=>v(t,e)}function v(t,e){N.get(t)?.delete(e)}function u(t,e){N.get(t)?.forEach(r=>{try{r(e)}catch(o){console.error(`[offline-data-manager] Error in "${t}" listener:`,o)}})}function z(t,e){let r=o=>{e(o),v(t,r)};C(t,r)}async function x(){if(!navigator?.storage?.estimate)return{usage:0,quota:1/0,available:1/0};let{usage:t=0,quota:e=1/0}=await navigator.storage.estimate();return{usage:t,quota:e,available:e-t}}async function mt(t){let{available:e,quota:r}=await x();return e-r*.1>=t}async function V(){return navigator?.storage?.persist?navigator.storage.persist():!1}async function Z(){return navigator?.storage?.persisted?navigator.storage.persisted():!1}function Q(t){return t===1/0?"\u221E":t<1024?`${t} B`:t<1024**2?`${(t/1024).toFixed(1)} KB`:t<1024**3?`${(t/1024**2).toFixed(1)} MB`:`${(t/1024**3).toFixed(2)} GB`}var F=null,B=null,P=!1,J=!0;function yt(){u("connectivity",{online:!1}),F?.()}function Et(){u("connectivity",{online:!0}),B?.()}function gt({pauseAll:t,resumeAll:e}){P||(F=t,B=e,window&&(window.addEventListener("offline",yt),window.addEventListener("online",Et)),P=!0)}function W(){globalThis.window&&(window.removeEventListener("offline",yt),window.removeEventListener("online",Et)),F=null,B=null,P=!1}function O(){return globalThis.window?navigator.onLine??!0:J}function q(){return P}function tt(t){J=t,P&&(J?B?.():F?.())}var Mt=2*1024*1024,Ct=5*1024*1024,Qt=2,Dt=5,Ft=1e3,E=new Map,b=!1,Y=null;function Rt(){return new Promise(t=>{Y=t})}function T(){if(Y){let t=Y;Y=null,t()}}var Bt=t=>new Promise(e=>setTimeout(e,t)),Wt=t=>Ft*Math.pow(2,t);async function y(t,e){let r=await f(s.DOWNLOAD_QUEUE,t);if(!r)return;await m(s.DOWNLOAD_QUEUE,{...r,...e});let{data:o,...n}=e;Object.keys(n).length>0&&await k(t,n)}async function qt(t,e){try{let r=await fetch(t,{method:"HEAD",signal:e}),o=r.headers.get("Accept-Ranges")==="bytes",n=r.headers.get("Content-Encoding"),a=!!n&&n!=="identity",d=r.headers.get("Content-Length"),i=d&&!a?parseInt(d,10):null,c=At(r.headers.get("Content-Type"));return{supportsRange:o,totalBytes:i,mimeType:c}}catch{return{supportsRange:!1,totalBytes:null,mimeType:null}}}function At(t){return t&&t.split(";")[0].trim()||null}function bt(t){let e=t.reduce((n,a)=>n+a.byteLength,0),r=new Uint8Array(e),o=0;for(let n of t)r.set(n,o),o+=n.byteLength;return r}async function Yt(t){let{id:e,downloadUrl:r,ttl:o}=t,n=new AbortController;E.set(e,n);let a=await f(s.DOWNLOAD_QUEUE,e),d=a?.retryCount??0;for(;d<=Dt;)try{await y(e,{status:l.IN_PROGRESS,lastAttemptAt:Date.now(),retryCount:d,errorMessage:null}),u("status",{id:e,status:l.IN_PROGRESS}),a=await f(s.DOWNLOAD_QUEUE,e);let i=a?.byteOffset??0,c=!1,p=a?.totalBytes??t.totalBytes??null,w=t.mimeType??null;if(i===0){let A=await qt(r,n.signal);c=A.supportsRange,A.totalBytes&&(p=A.totalBytes,await y(e,{totalBytes:p})),!w&&A.mimeType&&(w=A.mimeType)}else c=!0;let g=c&&p&&p>Ct,R,U=null;if(g)R=await kt(e,r,i,p,n.signal);else{let A=await $t(e,r,n.signal);R=A.uint8,U=A.mimeType}let dt=w??U??"application/octet-stream",L=R.buffer,ct=Date.now(),It=St(ct,o);await y(e,{status:l.COMPLETE,data:L,mimeType:dt,bytesDownloaded:L.byteLength,byteOffset:L.byteLength,storedBytes:L?.byteLength,completedAt:ct,expiresAt:It,errorMessage:null,deferredReason:null}),u("complete",{id:e,mimeType:dt}),E.delete(e);return}catch(i){if(i?.name==="QuotaExceededError"){await $(),await y(e,{status:l.DEFERRED,deferredReason:"insufficient-storage"}),u("error",{id:e,reason:"insufficient-storage",willRetry:!1});return}else if(i?.name==="AbortError"){await y(e,{status:l.PAUSED}),u("status",{id:e,status:l.PAUSED}),E.delete(e);return}if(d++,d>Dt){await y(e,{status:l.FAILED,retryCount:d,errorMessage:i.message}),u("error",{id:e,error:i,retryCount:d}),E.delete(e);return}let c=Wt(d-1);console.warn(`[offline-data-manager] "${e}" failed (attempt ${d}), retrying in ${c}ms:`,i.message),u("error",{id:e,error:i,retryCount:d,willRetry:!0}),await y(e,{status:l.PENDING,retryCount:d,errorMessage:i.message}),await Bt(c)}}async function $t(t,e,r){let o=await fetch(e,{signal:r});if(!o.ok)throw new Error(`HTTP ${o.status} ${o.statusText}`);let n=o.headers.get("Content-Encoding"),a=!!n&&n!=="identity",d=o.headers.get("Content-Length"),i=d&&!a?parseInt(d,10):null,c=At(o.headers.get("Content-Type")),p=o.body.getReader(),w=[],g=0;for(;;){let{done:R,value:U}=await p.read();if(R)break;w.push(U),g+=U.byteLength,await y(t,{bytesDownloaded:g,totalBytes:i}),u("progress",{id:t,bytesDownloaded:g,totalBytes:i,percent:i?Math.round(g/i*100):null})}return{uint8:bt(w),mimeType:c}}async function kt(t,e,r,o,n){let a=r,d=[],i=r;for(;a<o;){let c=Math.min(a+Mt-1,o-1),p=await fetch(e,{signal:n,headers:{Range:`bytes=${a}-${c}`}});if(!p.ok&&p.status!==206)throw new Error(`HTTP ${p.status} on Range bytes=${a}-${c}`);let w=new Uint8Array(await p.arrayBuffer());d.push(w),a+=w.byteLength,i+=w.byteLength,await y(t,{bytesDownloaded:i,byteOffset:a}),u("progress",{id:t,bytesDownloaded:i,totalBytes:o,percent:Math.round(i/o*100)})}return bt(d)}async function jt(t){await ht();let[e,r]=await Promise.all([D(s.REGISTRY),D(s.DOWNLOAD_QUEUE)]),o=new Map(e.map(i=>[i.id,i])),n=r.filter(i=>[l.PENDING,l.IN_PROGRESS,l.PAUSED,l.DEFERRED,l.EXPIRED].includes(i.status)).sort((i,c)=>(o.get(i.id)?.priority??10)-(o.get(c.id)?.priority??10));if(n.length===0)return;let a=[...n],d=new Set;await new Promise(i=>{function c(){if(!b){i();return}if(a.length===0){d.size===0&&i();return}if(d.size>=t)return;let p=a.shift(),w=o.get(p.id);if(!w){c();return}let g=(async()=>{let R=w.totalBytes??p.totalBytes??0;if(R>0&&!await mt(R)){await y(p.id,{status:l.DEFERRED,deferredReason:"insufficient-storage"}),u("deferred",{id:p.id,reason:"insufficient-storage"});return}await Yt(w)})().finally(()=>{d.delete(g),c()});d.add(g),c()}c()})}function et({concurrency:t=Qt}={}){b||(b=!0,(async()=>{for(;b;){if(!O()){let e=await D(s.DOWNLOAD_QUEUE);for(let r of e)r.status===l.IN_PROGRESS&&(E.get(r.id)?.abort(),E.delete(r.id),await y(r.id,{status:l.PAUSED,deferredReason:"network-offline"}));u("connectivity",{online:!1}),await Rt();continue}await jt(t),b&&await Rt()}})())}async function $(){b=!1,T(),await S(),u("stopped",{})}async function rt(){let t=await D(s.DOWNLOAD_QUEUE);for(let e of t)e.status===l.FAILED&&await y(e.id,{status:l.PENDING,retryCount:0,errorMessage:null});T()}function nt(){return b}async function _(t){E.get(t)?.abort(),E.delete(t)}async function S(){for(let[t,e]of E)e.abort(),E.delete(t)}function ot(){gt({pauseAll:S,resumeAll:T})}var l={PENDING:"pending",IN_PROGRESS:"in-progress",PAUSED:"paused",COMPLETE:"complete",EXPIRED:"expired",FAILED:"failed",DEFERRED:"deferred"},j=new Set([l.COMPLETE,l.EXPIRED]);function Ht(t){if(!t||typeof t!="object")throw new Error("Registry entry must be an object.");if(!t.id||typeof t.id!="string")throw new Error('Registry entry must have a string "id".');if(!t.downloadUrl||typeof t.downloadUrl!="string")throw new Error(`Entry "${t.id}" must have a string "downloadUrl".`);if(t.mimeType!==void 0&&t.mimeType!==null&&typeof t.mimeType!="string")throw new Error(`Entry "${t.id}" mimeType must be a string or omitted.`);if(typeof t.version!="number"||!Number.isInteger(t.version)||t.version<0)throw new Error(`Entry "${t.id}" version must be a non-negative integer.`);if(t.ttl!==void 0&&(typeof t.ttl!="number"||t.ttl<0))throw new Error(`Entry "${t.id}" ttl must be a non-negative number (seconds).`)}function xt(t){return{id:t,status:l.PENDING,data:null,bytesDownloaded:0,totalBytes:null,byteOffset:0,retryCount:0,lastAttemptAt:null,errorMessage:null,deferredReason:null,completedAt:null,expiresAt:null}}async function k(t,e){let r=await f(s.REGISTRY,t);r&&await m(s.REGISTRY,{...r,...e})}function St(t,e){return e?t+e*1e3:null}function Xt(t){return t?Date.now()>=t:!1}async function H(t){try{Ht(t);let e=Date.now(),r=await f(s.REGISTRY,t.id),o=await f(s.DOWNLOAD_QUEUE,t.id),n={id:t.id,downloadUrl:t.downloadUrl,mimeType:t.mimeType??null,version:t.version,protected:t.protected??!1,priority:t.priority??10,ttl:t.ttl??0,totalBytes:t.totalBytes??null,metadata:t.metadata??{},registeredAt:r?.registeredAt??e,updatedAt:e,...r?{}:{status:l.PENDING,bytesDownloaded:0,retryCount:0,lastAttemptAt:null,errorMessage:null,deferredReason:null,completedAt:null,expiresAt:null}};if(r){if(t.version>r.version){await m(s.REGISTRY,n);let a=o?{...o,status:l.PENDING,bytesDownloaded:0,byteOffset:0,retryCount:0,errorMessage:null,deferredReason:null,completedAt:null,expiresAt:null}:xt(t.id);await m(s.DOWNLOAD_QUEUE,a),await k(t.id,{status:l.PENDING,bytesDownloaded:0,retryCount:0,errorMessage:null,deferredReason:null,completedAt:null,expiresAt:null}),u("registered",{id:t.id,reason:"version-updated"}),T()}return}await m(s.REGISTRY,n),await m(s.DOWNLOAD_QUEUE,xt(t.id)),u("registered",{id:t.id,reason:"new"}),T()}catch(e){if(e?.name==="QuotaExceededError"){u("error",{id,reason:"insufficient-storage",willRetry:!1});return}else u("error",{id,reason:e?.message??e,willRetry:!1})}}async function at(t){if(!Array.isArray(t))throw new Error("registerFiles expects an array.");let e=new Set(t.map(n=>n.id)),r=await D(s.REGISTRY),o=[];for(let n of r)!e.has(n.id)&&!n.protected&&(await h(s.REGISTRY,n.id),await h(s.DOWNLOAD_QUEUE,n.id),o.push(n.id),u("deleted",{id:n.id,registryRemoved:!0}));for(let n of t)await H(n);return{registered:t.map(n=>n.id),removed:o}}async function Ot(t,e){try{if(t&&e){let r=await f(s.REGISTRY,entry.id);r&&(r.metadata={...r.metadata??{},...e},await m(s.REGISTRY,r))}}catch(r){if(r?.name==="QuotaExceededError"){u("error",{id:t,reason:"insufficient-storage",willRetry:!1});return}else u("error",{id:t,reason:r?.message??r,willRetry:!1})}}async function ht(){let t=await D(s.DOWNLOAD_QUEUE),e=[];for(let r of t)r.status===l.COMPLETE&&Xt(r.expiresAt)&&(await m(s.DOWNLOAD_QUEUE,{...r,status:l.EXPIRED}),await k(r.id,{status:l.EXPIRED}),e.push(r.id),u("expired",{id:r.id}));return e}async function st(){let[t,e]=await Promise.all([D(s.REGISTRY),x()]);return{items:t.map(o=>Tt(o)).sort((o,n)=>o.priority-n.priority),storage:{usageBytes:e.usage,quotaBytes:e.quota,availableBytes:e.available,usageFormatted:Q(e.usage),quotaFormatted:Q(e.quota),availableFormatted:Q(e.available)}}}async function it(t){let e=await f(s.REGISTRY,t);return e?Tt(e):null}function Tt(t){return{id:t.id,downloadUrl:t.downloadUrl,mimeType:t.mimeType??null,version:t.version,protected:t.protected,priority:t.priority,ttl:t.ttl,totalBytes:t.totalBytes,metadata:t.metadata,registeredAt:t.registeredAt,updatedAt:t.updatedAt,downloadStatus:t.status??null,bytesDownloaded:t.bytesDownloaded??0,progress:t.totalBytes&&t.bytesDownloaded?Math.round(t.bytesDownloaded/t.totalBytes*100):null,retryCount:t.retryCount??0,lastAttemptAt:t.lastAttemptAt??null,errorMessage:t.errorMessage??null,deferredReason:t.deferredReason??null,completedAt:t.completedAt??null,expiresAt:t.expiresAt??null}}async function lt(t){let e=await f(s.REGISTRY,t);if(e?.status)return j.has(e?.status);let r=await f(s.DOWNLOAD_QUEUE,t);return j.has(r?.status)}async function Kt(t){let e=await f(s.DOWNLOAD_QUEUE,t);e&&await m(s.DOWNLOAD_QUEUE,{...e,status:l.PENDING,data:null,bytesDownloaded:0,byteOffset:0,retryCount:0,errorMessage:null,deferredReason:null,completedAt:null,expiresAt:null})}async function X(t,{removeProtected:e=!1}={}){let r=await f(s.REGISTRY,t);if(!r)throw new Error(`deleteFile: No registered file with id "${t}".`);await _(t);let o=e||!r.protected;return o?(await h(s.REGISTRY,t),await h(s.DOWNLOAD_QUEUE,t)):await Kt(t),u("deleted",{id:t,registryRemoved:o}),{id:t,registryRemoved:o}}async function ut({removeProtected:t=!1}={}){await S();let e=await M(s.REGISTRY);return Promise.all(e.map(r=>X(r,{removeProtected:t})))}async function Ut(t){let[e,r]=await Promise.all([f(s.REGISTRY,t),f(s.DOWNLOAD_QUEUE,t)]);if(!e)throw new Error(`retrieve: No registered file with id "${t}".`);if(!j.has(r?.status)||!r?.data)throw new Error(`retrieve: File "${t}" has no data yet (status: ${r?.status??"unknown"}).`);return{data:r.data,mimeType:r.mimeType}}var zt={setDBInfo:wt,dbGetAllIds:M,registerFile:H,registerFiles:at,startDownloads:et,stopDownloads:$,retryFailed:rt,isDownloading:nt,abortDownload:_,abortAllDownloads:S,startMonitoring:ot,stopMonitoring:W,isOnline:O,isMonitoring:q,updateConnectivityStatus:tt,retrieve:Ut,getAllStatus:st,getStatus:it,isReady:lt,delete:X,deleteAll:ut,on:C,off:v,once:z,getStorageEstimate:x,requestPersistentStorage:V,isPersistentStorage:Z},Vt=zt;return Gt(Zt);})();
