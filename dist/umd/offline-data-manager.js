"use strict";var offlineMapData=(()=>{var k=Object.defineProperty;var xe=Object.getOwnPropertyDescriptor;var Ue=Object.getOwnPropertyNames;var Te=Object.prototype.hasOwnProperty;var Ie=(e,t)=>{for(var r in t)k(e,r,{get:t[r],enumerable:!0})},ve=(e,t,r,a)=>{if(t&&typeof t=="object"||typeof t=="function")for(let o of Ue(t))!Te.call(e,o)&&o!==r&&k(e,o,{get:()=>t[o],enumerable:!(a=xe(t,o))||a.enumerable});return e};var Le=e=>ve(k({},"__esModule",{value:!0}),e);var Xe={};Ie(Xe,{abortAllDownloads:()=>S,abortDownload:()=>N,default:()=>He,deleteAllFiles:()=>se,deleteFile:()=>$,emit:()=>u,getAllStatus:()=>oe,getStatus:()=>ne,getStorageEstimate:()=>O,isDownloading:()=>J,isMonitoring:()=>C,isOnline:()=>x,isPersistentStorage:()=>X,isReady:()=>ae,off:()=>L,on:()=>M,once:()=>j,registerFile:()=>W,registerFiles:()=>re,requestPersistentStorage:()=>H,retrieve:()=>he,retryFailed:()=>Z,startDownloads:()=>V,startMonitoring:()=>ee,stopDownloads:()=>q,stopMonitoring:()=>Q,updateRegistryMetadata:()=>Se});var ue="offline-data-manager",de=1,_=null,s={REGISTRY:"registry",DOWNLOAD_QUEUE:"downloadQueue"};async function ce(e,t){ue=e??"offline-data-manager",de=t??1}async function I(){return _||(_=await new Promise((e,t)=>{let r=indexedDB.open(ue,de);r.onupgradeneeded=a=>{let o=a.target.result;if(!o.objectStoreNames.contains(s.REGISTRY)){let n=o.createObjectStore(s.REGISTRY,{keyPath:"id"});n.createIndex("protected","protected",{unique:!1}),n.createIndex("priority","priority",{unique:!1})}if(!o.objectStoreNames.contains(s.DOWNLOAD_QUEUE)){let n=o.createObjectStore(s.DOWNLOAD_QUEUE,{keyPath:"id"});n.createIndex("status","status",{unique:!1}),n.createIndex("priority","priority",{unique:!1})}},r.onsuccess=()=>e(r.result),r.onerror=()=>t(r.error)}),_)}async function p(e,t){let r=await I();return new Promise((a,o)=>{let n=r.transaction(e,"readonly").objectStore(e).get(t);n.onsuccess=()=>a(n.result),n.onerror=()=>o(n.error)})}async function E(e){let t=await I();return new Promise((r,a)=>{let o=t.transaction(e,"readonly").objectStore(e).getAll();o.onsuccess=()=>r(o.result),o.onerror=()=>a(o.error)})}async function P(e){let t=await I();return new Promise((r,a)=>{let o=t.transaction(e,"readonly").objectStore(e).getAllKeys();o.onsuccess=()=>r(o.result),o.onerror=()=>a(o.error)})}async function y(e,t){let r=await I();return new Promise((a,o)=>{let n=r.transaction(e,"readwrite").objectStore(e).put(t);n.onsuccess=()=>a(),n.onerror=()=>o(n.error),n.onerror=()=>o(n.error)})}async function h(e,t){let r=await I();return new Promise((a,o)=>{let n=r.transaction(e,"readwrite").objectStore(e).delete(t);n.onsuccess=()=>a(),n.onerror=()=>o(n.error)})}var v=new Map;function M(e,t){return v.has(e)||v.set(e,new Set),v.get(e).add(t),()=>L(e,t)}function L(e,t){v.get(e)?.delete(t)}function u(e,t){v.get(e)?.forEach(r=>{try{r(t)}catch(a){console.error(`[offline-data-manager] Error in "${e}" listener:`,a)}})}function j(e,t){let r=a=>{t(a),L(e,r)};M(e,r)}async function O(){if(!navigator?.storage?.estimate)return{usage:0,quota:1/0,available:1/0};let{usage:e=0,quota:t=1/0}=await navigator.storage.estimate();return{usage:e,quota:t,available:t-e}}async function fe(e){let{available:t,quota:r}=await O();return t-r*.1>=e}async function H(){return navigator?.storage?.persist?navigator.storage.persist():!1}async function X(){return navigator?.storage?.persisted?navigator.storage.persisted():!1}function G(e){return e===1/0?"\u221E":e<1024?`${e} B`:e<1024**2?`${(e/1024).toFixed(1)} KB`:e<1024**3?`${(e/1024**2).toFixed(1)} MB`:`${(e/1024**3).toFixed(2)} GB`}var K=null,z=null,B=!1;function pe(){u("connectivity",{online:!1}),K?.()}function we(){u("connectivity",{online:!0}),z?.()}function me({pauseAll:e,resumeAll:t}){B||(K=e,z=t,window.addEventListener("offline",pe),window.addEventListener("online",we),B=!0)}function Q(){window.removeEventListener("offline",pe),window.removeEventListener("online",we),K=null,z=null,B=!1}function x(){return navigator.onLine??!0}function C(){return B}var Ne=2*1024*1024,_e=5*1024*1024,Pe=2,ye=5,Me=1e3,g=new Map,b=!1,F=null;function Ee(){return new Promise(e=>{F=e})}function U(){if(F){let e=F;F=null,e()}}var Ge=e=>new Promise(t=>setTimeout(t,e)),Be=e=>Me*Math.pow(2,e);async function m(e,t){let r=await p(s.DOWNLOAD_QUEUE,e);r&&await y(s.DOWNLOAD_QUEUE,{...r,...t})}async function Qe(e,t){try{let r=await fetch(e,{method:"HEAD",signal:t}),a=r.headers.get("Accept-Ranges")==="bytes",o=r.headers.get("Content-Encoding"),n=!!o&&o!=="identity",i=r.headers.get("Content-Length"),l=i&&!n?parseInt(i,10):null,c=ge(r.headers.get("Content-Type"));return{supportsRange:a,totalBytes:l,mimeType:c}}catch{return{supportsRange:!1,totalBytes:null,mimeType:null}}}function ge(e){return e&&e.split(";")[0].trim()||null}function De(e){let t=e.reduce((o,n)=>o+n.byteLength,0),r=new Uint8Array(t),a=0;for(let o of e)r.set(o,a),a+=o.byteLength;return r}async function Ce(e){let{id:t,downloadUrl:r,ttl:a}=e,o=new AbortController;g.set(t,o);let n=await p(s.DOWNLOAD_QUEUE,t),i=n?.retryCount??0;for(;i<=ye;)try{await m(t,{status:d.IN_PROGRESS,lastAttemptAt:Date.now(),retryCount:i,errorMessage:null}),u("status",{id:t,status:d.IN_PROGRESS}),n=await p(s.DOWNLOAD_QUEUE,t);let l=n?.byteOffset??0,c=!1,f=n?.totalBytes??e.totalBytes??null,w=e.mimeType??null;if(l===0){let R=await Qe(r,o.signal);c=R.supportsRange,R.totalBytes&&(f=R.totalBytes,await m(t,{totalBytes:f})),!w&&R.mimeType&&(w=R.mimeType)}else c=!0;let D=c&&f&&f>_e,A,T=null;if(D)A=await qe(t,r,l,f,o.signal);else{let R=await Fe(t,r,o.signal);A=R.uint8,T=R.mimeType}let ie=w??T??"application/octet-stream",Y=A.buffer,le=Date.now(),Oe=Ae(le,a);await m(t,{status:d.COMPLETE,data:Y,mimeType:ie,bytesDownloaded:Y.byteLength,byteOffset:Y.byteLength,completedAt:le,expiresAt:Oe,errorMessage:null,deferredReason:null}),u("complete",{id:t,mimeType:ie}),g.delete(t);return}catch(l){if(l?.name==="QuotaExceededError"){await q(),await m(t,{status:d.DEFERRED,deferredReason:"insufficient-storage"}),u("error",{id:t,reason:"insufficient-storage",willRetry:!1});return}else if(l?.name==="AbortError"){await m(t,{status:d.PAUSED}),u("status",{id:t,status:d.PAUSED}),g.delete(t);return}if(i++,i>ye){await m(t,{status:d.FAILED,retryCount:i,errorMessage:l.message}),u("error",{id:t,error:l,retryCount:i}),g.delete(t);return}let c=Be(i-1);console.warn(`[offline-data-manager] "${t}" failed (attempt ${i}), retrying in ${c}ms:`,l.message),u("error",{id:t,error:l,retryCount:i,willRetry:!0}),await m(t,{status:d.PENDING,retryCount:i,errorMessage:l.message}),await Ge(c)}}async function Fe(e,t,r){let a=await fetch(t,{signal:r});if(!a.ok)throw new Error(`HTTP ${a.status} ${a.statusText}`);let o=a.headers.get("Content-Encoding"),n=!!o&&o!=="identity",i=a.headers.get("Content-Length"),l=i&&!n?parseInt(i,10):null,c=ge(a.headers.get("Content-Type")),f=a.body.getReader(),w=[],D=0;for(;;){let{done:A,value:T}=await f.read();if(A)break;w.push(T),D+=T.byteLength,await m(e,{bytesDownloaded:D,totalBytes:l}),u("progress",{id:e,bytesDownloaded:D,totalBytes:l,percent:l?Math.round(D/l*100):null})}return{uint8:De(w),mimeType:c}}async function qe(e,t,r,a,o){let n=r,i=[],l=r;for(;n<a;){let c=Math.min(n+Ne-1,a-1),f=await fetch(t,{signal:o,headers:{Range:`bytes=${n}-${c}`}});if(!f.ok&&f.status!==206)throw new Error(`HTTP ${f.status} on Range bytes=${n}-${c}`);let w=new Uint8Array(await f.arrayBuffer());i.push(w),n+=w.byteLength,l+=w.byteLength,await m(e,{bytesDownloaded:l,byteOffset:n}),u("progress",{id:e,bytesDownloaded:l,totalBytes:a,percent:Math.round(l/a*100)})}return De(i)}async function We(e){await Re();let[t,r]=await Promise.all([E(s.REGISTRY),E(s.DOWNLOAD_QUEUE)]),a=new Map(t.map(l=>[l.id,l])),o=r.filter(l=>[d.PENDING,d.IN_PROGRESS,d.PAUSED,d.DEFERRED,d.EXPIRED].includes(l.status)).sort((l,c)=>(a.get(l.id)?.priority??10)-(a.get(c.id)?.priority??10));if(o.length===0)return;let n=[...o],i=new Set;await new Promise(l=>{function c(){if(!b){l();return}if(n.length===0){i.size===0&&l();return}if(i.size>=e)return;let f=n.shift(),w=a.get(f.id);if(!w){c();return}let D=(async()=>{let A=w.totalBytes??f.totalBytes??0;if(A>0&&!await fe(A)){await m(f.id,{status:d.DEFERRED,deferredReason:"insufficient-storage"}),u("deferred",{id:f.id,reason:"insufficient-storage"});return}await Ce(w)})().finally(()=>{i.delete(D),c()});i.add(D),c()}c()})}function V({concurrency:e=Pe}={}){b||(b=!0,(async()=>{for(;b;){if(!x()){let t=await E(s.DOWNLOAD_QUEUE);for(let r of t)r.status===d.IN_PROGRESS&&(g.get(r.id)?.abort(),g.delete(r.id),await m(r.id,{status:d.PAUSED,deferredReason:"network-offline"}));u("connectivity",{online:!1}),await Ee();continue}await We(e),b&&await Ee()}})())}async function q(){b=!1,U(),await S(),u("stopped",{})}async function Z(){let e=await E(s.DOWNLOAD_QUEUE);for(let t of e)t.status===d.FAILED&&await m(t.id,{status:d.PENDING,retryCount:0,errorMessage:null});U()}function J(){return b}async function N(e){g.get(e)?.abort(),g.delete(e)}async function S(){for(let[e,t]of g)t.abort(),g.delete(e)}function ee(){me({pauseAll:S,resumeAll:U})}var d={PENDING:"pending",IN_PROGRESS:"in-progress",PAUSED:"paused",COMPLETE:"complete",EXPIRED:"expired",FAILED:"failed",DEFERRED:"deferred"},te=new Set([d.COMPLETE,d.EXPIRED]);function $e(e){if(!e||typeof e!="object")throw new Error("Registry entry must be an object.");if(!e.id||typeof e.id!="string")throw new Error('Registry entry must have a string "id".');if(!e.downloadUrl||typeof e.downloadUrl!="string")throw new Error(`Entry "${e.id}" must have a string "downloadUrl".`);if(e.mimeType!==void 0&&e.mimeType!==null&&typeof e.mimeType!="string")throw new Error(`Entry "${e.id}" mimeType must be a string or omitted.`);if(typeof e.version!="number"||!Number.isInteger(e.version)||e.version<0)throw new Error(`Entry "${e.id}" version must be a non-negative integer.`);if(e.ttl!==void 0&&(typeof e.ttl!="number"||e.ttl<0))throw new Error(`Entry "${e.id}" ttl must be a non-negative number (seconds).`)}function be(e){return{id:e,status:d.PENDING,data:null,bytesDownloaded:0,totalBytes:null,byteOffset:0,retryCount:0,lastAttemptAt:null,errorMessage:null,deferredReason:null,completedAt:null,expiresAt:null}}function Ae(e,t){return t?e+t*1e3:null}function Ye(e){return e?Date.now()>=e:!1}async function W(e){try{$e(e);let t=Date.now(),r=await p(s.REGISTRY,e.id),a=await p(s.DOWNLOAD_QUEUE,e.id),o={id:e.id,downloadUrl:e.downloadUrl,mimeType:e.mimeType??null,version:e.version,protected:e.protected??!1,priority:e.priority??10,ttl:e.ttl??0,totalBytes:e.totalBytes??null,metadata:e.metadata??{},registeredAt:r?.registeredAt??t,updatedAt:t};if(r){if(e.version>r.version){await y(s.REGISTRY,o);let n=a?{...a,status:d.PENDING,bytesDownloaded:0,byteOffset:0,retryCount:0,errorMessage:null,deferredReason:null,completedAt:null,expiresAt:null}:be(e.id);await y(s.DOWNLOAD_QUEUE,n),u("registered",{id:e.id,reason:"version-updated"}),U()}return}await y(s.REGISTRY,o),await y(s.DOWNLOAD_QUEUE,be(e.id)),u("registered",{id:e.id,reason:"new"}),U()}catch(t){if(t?.name==="QuotaExceededError"){u("error",{id,reason:"insufficient-storage",willRetry:!1});return}else u("error",{id,reason:t?.message??t,willRetry:!1})}}async function re(e){if(!Array.isArray(e))throw new Error("registerFiles expects an array.");let t=new Set(e.map(o=>o.id)),r=await E(s.REGISTRY),a=[];for(let o of r)!t.has(o.id)&&!o.protected&&(await h(s.REGISTRY,o.id),await h(s.DOWNLOAD_QUEUE,o.id),a.push(o.id),u("deleted",{id:o.id,registryRemoved:!0}));for(let o of e)await W(o);return{registered:e.map(o=>o.id),removed:a}}async function Se(e,t){try{if(e&&t){let r=await p(s.REGISTRY,entry.id);r&&(r.metadata={...r.metadata??{},...t},await y(s.REGISTRY,r))}}catch(r){if(r?.name==="QuotaExceededError"){u("error",{id:e,reason:"insufficient-storage",willRetry:!1});return}else u("error",{id:e,reason:r?.message??r,willRetry:!1})}}async function Re(){let e=await E(s.DOWNLOAD_QUEUE),t=[];for(let r of e)r.status===d.COMPLETE&&Ye(r.expiresAt)&&(await y(s.DOWNLOAD_QUEUE,{...r,status:d.EXPIRED}),t.push(r.id),u("expired",{id:r.id}));return t}async function oe(){let[e,t,r]=await Promise.all([E(s.REGISTRY),E(s.DOWNLOAD_QUEUE),O()]),a=new Map(t.map(n=>[n.id,n]));return{items:e.map(n=>{let i=a.get(n.id)??null;return{id:n.id,downloadUrl:n.downloadUrl,mimeType:n.mimeType,version:n.version,protected:n.protected,priority:n.priority,ttl:n.ttl,totalBytes:n.totalBytes,metadata:n.metadata,registeredAt:n.registeredAt,updatedAt:n.updatedAt,downloadStatus:i?.status??null,bytesDownloaded:i?.bytesDownloaded??0,storedBytes:i?.data?.length??null,progress:i?.totalBytes&&i?.bytesDownloaded?Math.round(i.bytesDownloaded/i.totalBytes*100):null,retryCount:i?.retryCount??0,lastAttemptAt:i?.lastAttemptAt??null,errorMessage:i?.errorMessage??null,deferredReason:i?.deferredReason??null,completedAt:i?.completedAt??null,expiresAt:i?.expiresAt??null}}).sort((n,i)=>n.priority-i.priority),storage:{usageBytes:r.usage,quotaBytes:r.quota,availableBytes:r.available,usageFormatted:G(r.usage),quotaFormatted:G(r.quota),availableFormatted:G(r.available)}}}async function ne(e){let[t,r]=await Promise.all([p(s.REGISTRY,e),p(s.DOWNLOAD_QUEUE,e)]);return t?{id:t.id,downloadUrl:t.downloadUrl,mimeType:t.mimeType??null,version:t.version,protected:t.protected,priority:t.priority,ttl:t.ttl,totalBytes:t.totalBytes,metadata:t.metadata,registeredAt:t.registeredAt,updatedAt:t.updatedAt,downloadStatus:r?.status??null,bytesDownloaded:r?.bytesDownloaded??0,storedBytes:r?.data?.length??null,progress:r?.totalBytes&&r?.bytesDownloaded?Math.round(r.bytesDownloaded/r.totalBytes*100):null,retryCount:r?.retryCount??0,lastAttemptAt:r?.lastAttemptAt??null,errorMessage:r?.errorMessage??null,deferredReason:r?.deferredReason??null,completedAt:r?.completedAt??null,expiresAt:r?.expiresAt??null}:null}async function ae(e){let t=await p(s.DOWNLOAD_QUEUE,e);return te.has(t?.status)}async function ke(e){let t=await p(s.DOWNLOAD_QUEUE,e);t&&await y(s.DOWNLOAD_QUEUE,{...t,status:d.PENDING,data:null,bytesDownloaded:0,byteOffset:0,retryCount:0,errorMessage:null,deferredReason:null,completedAt:null,expiresAt:null})}async function $(e,{removeProtected:t=!1}={}){let r=await p(s.REGISTRY,e);if(!r)throw new Error(`deleteFile: No registered file with id "${e}".`);await N(e);let a=t||!r.protected;return a?(await h(s.REGISTRY,e),await h(s.DOWNLOAD_QUEUE,e)):await ke(e),u("deleted",{id:e,registryRemoved:a}),{id:e,registryRemoved:a}}async function se({removeProtected:e=!1}={}){await S();let t=await P(s.REGISTRY);return Promise.all(t.map(r=>$(r,{removeProtected:e})))}async function he(e){let[t,r]=await Promise.all([p(s.REGISTRY,e),p(s.DOWNLOAD_QUEUE,e)]);if(!t)throw new Error(`retrieve: No registered file with id "${e}".`);if(!te.has(r?.status)||!r?.data)throw new Error(`retrieve: File "${e}" has no data yet (status: ${r?.status??"unknown"}).`);return{data:r.data,mimeType:r.mimeType}}var je={setDBInfo:ce,dbGetAllIds:P,registerFile:W,registerFiles:re,startDownloads:V,stopDownloads:q,retryFailed:Z,isDownloading:J,abortDownload:N,abortAllDownloads:S,startMonitoring:ee,stopMonitoring:Q,isOnline:x,isMonitoring:C,retrieve:he,getAllStatus:oe,getStatus:ne,isReady:ae,delete:$,deleteAll:se,on:M,off:L,once:j,getStorageEstimate:O,requestPersistentStorage:H,isPersistentStorage:X},He=je;return Le(Xe);})();
