var Z="offline-data-manager",J=1,L=null,i={REGISTRY:"registry",DOWNLOAD_QUEUE:"downloadQueue"};async function tt(t,e){Z=t??"offline-data-manager",J=e??1}async function T(){return L||(L=await new Promise((t,e)=>{let n=indexedDB.open(Z,J);n.onupgradeneeded=r=>{let o=r.target.result;if(!o.objectStoreNames.contains(i.REGISTRY)){let a=o.createObjectStore(i.REGISTRY,{keyPath:"id"});a.createIndex("protected","protected",{unique:!1}),a.createIndex("priority","priority",{unique:!1})}if(!o.objectStoreNames.contains(i.DOWNLOAD_QUEUE)){let a=o.createObjectStore(i.DOWNLOAD_QUEUE,{keyPath:"id"});a.createIndex("status","status",{unique:!1}),a.createIndex("priority","priority",{unique:!1})}},n.onsuccess=()=>t(n.result),n.onerror=()=>e(n.error)}),L)}async function f(t,e){let n=await T();return new Promise((r,o)=>{let a=n.transaction(t,"readonly").objectStore(t).get(e);a.onsuccess=()=>r(a.result),a.onerror=()=>o(a.error)})}async function D(t){let e=await T();return new Promise((n,r)=>{let o=e.transaction(t,"readonly").objectStore(t).getAll();o.onsuccess=()=>n(o.result),o.onerror=()=>r(o.error)})}async function N(t){let e=await T();return new Promise((n,r)=>{let o=e.transaction(t,"readonly").objectStore(t).getAllKeys();o.onsuccess=()=>n(o.result),o.onerror=()=>r(o.error)})}async function w(t,e){let n=await T();return new Promise((r,o)=>{let a=n.transaction(t,"readwrite").objectStore(t).put(e);a.onsuccess=()=>r(),a.onerror=()=>o(a.error),a.onerror=()=>o(a.error)})}async function A(t,e){let n=await T();return new Promise((r,o)=>{let a=n.transaction(t,"readwrite").objectStore(t).delete(e);a.onsuccess=()=>r(),a.onerror=()=>o(a.error)})}var v=new Map;function W(t,e){return v.has(t)||v.set(t,new Set),v.get(t).add(e),()=>M(t,e)}function M(t,e){v.get(t)?.delete(e)}function u(t,e){v.get(t)?.forEach(n=>{try{n(e)}catch(r){console.error(`[offline-data-manager] Error in "${t}" listener:`,r)}})}function et(t,e){let n=r=>{e(r),M(t,n)};W(t,n)}async function I(){if(!navigator?.storage?.estimate)return{usage:0,quota:1/0,available:1/0};let{usage:t=0,quota:e=1/0}=await navigator.storage.estimate();return{usage:t,quota:e,available:e-t}}async function nt(t){let{available:e,quota:n}=await I();return e-n*.1>=t}async function ot(){return navigator?.storage?.persist?navigator.storage.persist():!1}async function rt(){return navigator?.storage?.persisted?navigator.storage.persisted():!1}function G(t){return t===1/0?"\u221E":t<1024?`${t} B`:t<1024**2?`${(t/1024).toFixed(1)} KB`:t<1024**3?`${(t/1024**2).toFixed(1)} MB`:`${(t/1024**3).toFixed(2)} GB`}var C=null,Q=null,U=!1,Y=!0;function at(){u("connectivity",{online:!1}),C?.()}function it(){u("connectivity",{online:!0}),Q?.()}function st({pauseAll:t,resumeAll:e}){U||(C=t,Q=e,window&&(window.addEventListener("offline",at),window.addEventListener("online",it)),U=!0)}function k(){globalThis.window&&(window.removeEventListener("offline",at),window.removeEventListener("online",it)),C=null,Q=null,U=!1}function P(){return globalThis.window?navigator.onLine??!0:Y}function $(){return U}function lt(t){Y=t,U&&(Y?Q?.():C?.())}var It={png:"image/png",jpg:"image/jpeg",jpeg:"image/jpeg",webp:"image/webp",svg:"image/svg+xml",ico:"image/x-icon",bmp:"image/bmp",gif:"image/gif",tif:"image/tiff",tiff:"image/tiff",avif:"image/avif",apng:"image/apng",mp4:"video/mp4",webm:"video/webm",mpeg:"video/mpeg",mp3:"audio/mpeg",wav:"audio/wav",ttf:"font/ttf",woff:"font/woff",woff2:"font/woff2",otf:"font/otf",json:"application/json",geojson:"application/json",geojsonseq:"application/json",topojson:"application/json",gpx:"application/xml",georss:"application/xml",gml:"application/xml",citygml:"application/xml",czml:"application/xml",xml:"application/xml",kml:"application/vnd.google-earth.kml+xml",xls:"application/vnd.ms-excel",xlsx:"application/vnd.ms-excel",gltf:"model/gltf+json",glb:"model/gltf-binary",dae:"model/vnd.collada+xml",zip:"application/zip",pbf:"application/x-protobuf",mvt:"application/vnd.mapbox-vector-tile",pdf:"application/pdf",terrian:"application/vnd.quantized-mesh",pmtiles:"application/vnd.pmtiles",htm:"text/html",html:"text/html",xhtml:"application/xhtml+xml",js:"text/javascript",css:"text/css",csv:"text/csv",md:"text/markdown",plain:"text/plain",txt:"text/plain",wat:"text/plain",wsv:"text/wsv",wasm:"application/wasm"};function ut(t){if(t&&typeof t=="string"&&t.includes(".")){let e=t.split(".").pop().toLowerCase(),n=It[e];if(n)return n}return"application/octet-stream"}var Ut=2*1024*1024,Pt=5*1024*1024,_t=2,dt=5,Lt=1e3,y=new Map,b=!1,B=null;function ct(){return new Promise(t=>{B=t})}function S(){if(B){let t=B;B=null,t()}}var Nt=t=>new Promise(e=>setTimeout(e,t)),Mt=t=>Lt*Math.pow(2,t);async function g(t,e){let n=await f(i.DOWNLOAD_QUEUE,t);if(!n)return;await w(i.DOWNLOAD_QUEUE,{...n,...e});let{data:r,...o}=e;Object.keys(o).length>0&&await q(t,o)}async function Gt(t,e){try{let n=await fetch(t,{method:"HEAD",signal:e}),r=n.headers.get("Accept-Ranges")==="bytes",o=n.headers.get("Content-Encoding"),a=!!o&&o!=="identity",d=n.headers.get("Content-Length"),s=d&&!a?parseInt(d,10):null,c=ft(n.headers.get("Content-Type"));return{supportsRange:r,totalBytes:s,mimeType:c}}catch{return{supportsRange:!1,totalBytes:null,mimeType:null}}}function ft(t){return t&&t.split(";")[0].trim()||null}function pt(t){let e=t.reduce((o,a)=>o+a.byteLength,0),n=new Uint8Array(e),r=0;for(let o of t)n.set(o,r),r+=o.byteLength;return n}async function Ct(t){let{id:e,downloadUrl:n,ttl:r}=t,o=new AbortController;y.set(e,o);let a=await f(i.DOWNLOAD_QUEUE,e),d=a?.retryCount??0;for(;d<=dt;)try{await g(e,{status:l.IN_PROGRESS,lastAttemptAt:Date.now(),retryCount:d,errorMessage:null}),u("status",{id:e,status:l.IN_PROGRESS}),a=await f(i.DOWNLOAD_QUEUE,e);let s=a?.byteOffset??0,c=!1,p=a?.totalBytes??t.totalBytes??null,m=t.mimeType??null;if(s===0){let x=await Gt(n,o.signal);c=x.supportsRange,x.totalBytes&&(p=x.totalBytes,await g(e,{totalBytes:p})),!m&&x.mimeType&&(m=x.mimeType)}else c=!0;let E=c&&p&&p>Pt,R,O=null;if(E)R=await Bt(e,n,s,p,o.signal);else{let x=await Qt(e,n,o.signal);R=x.uint8,O=x.mimeType}let Tt=ut(n),K=m??O??Tt,_=R.buffer,V=Date.now(),vt=Et(V,r);await g(e,{status:l.COMPLETE,data:_,mimeType:K,bytesDownloaded:_.byteLength,byteOffset:_.byteLength,storedBytes:_?.byteLength,completedAt:V,expiresAt:vt,errorMessage:null,deferredReason:null}),u("complete",{id:e,mimeType:K}),y.delete(e);return}catch(s){if(s?.name==="QuotaExceededError"){await z(),await g(e,{status:l.DEFERRED,deferredReason:"insufficient-storage"}),u("error",{id:e,reason:"insufficient-storage",willRetry:!1});return}else if(s?.name==="AbortError"){await g(e,{status:l.PAUSED}),u("status",{id:e,status:l.PAUSED}),y.delete(e);return}if(d++,d>dt){await g(e,{status:l.FAILED,retryCount:d,errorMessage:s.message}),u("error",{id:e,error:s,retryCount:d}),y.delete(e);return}let c=Mt(d-1);console.warn(`[offline-data-manager] "${e}" failed (attempt ${d}), retrying in ${c}ms:`,s.message),u("error",{id:e,error:s,retryCount:d,willRetry:!0}),await g(e,{status:l.PENDING,retryCount:d,errorMessage:s.message}),await Nt(c)}}async function Qt(t,e,n){let r=await fetch(e,{signal:n});if(!r.ok)throw new Error(`HTTP ${r.status} ${r.statusText}`);let o=r.headers.get("Content-Encoding"),a=!!o&&o!=="identity",d=r.headers.get("Content-Length"),s=d&&!a?parseInt(d,10):null,c=ft(r.headers.get("Content-Type")),p=r.body.getReader(),m=[],E=0;for(;;){let{done:R,value:O}=await p.read();if(R)break;m.push(O),E+=O.byteLength,await g(t,{bytesDownloaded:E,totalBytes:s}),u("progress",{id:t,bytesDownloaded:E,totalBytes:s,percent:s?Math.round(E/s*100):null})}return{uint8:pt(m),mimeType:c}}async function Bt(t,e,n,r,o){let a=n,d=[],s=n;for(;a<r;){let c=Math.min(a+Ut-1,r-1),p=await fetch(e,{signal:o,headers:{Range:`bytes=${a}-${c}`}});if(!p.ok&&p.status!==206)throw new Error(`HTTP ${p.status} on Range bytes=${a}-${c}`);let m=new Uint8Array(await p.arrayBuffer());d.push(m),a+=m.byteLength,s+=m.byteLength,await g(t,{bytesDownloaded:s,byteOffset:a}),u("progress",{id:t,bytesDownloaded:s,totalBytes:r,percent:Math.round(s/r*100)})}return pt(d)}async function Ft(t){await Dt();let[e,n]=await Promise.all([D(i.REGISTRY),D(i.DOWNLOAD_QUEUE)]),r=new Map(e.map(s=>[s.id,s])),o=n.filter(s=>[l.PENDING,l.IN_PROGRESS,l.PAUSED,l.DEFERRED,l.EXPIRED].includes(s.status)).sort((s,c)=>(r.get(s.id)?.priority??10)-(r.get(c.id)?.priority??10));if(o.length===0)return;let a=[...o],d=new Set;await new Promise(s=>{function c(){if(!b){s();return}if(a.length===0){d.size===0&&s();return}if(d.size>=t)return;let p=a.shift(),m=r.get(p.id);if(!m){c();return}let E=(async()=>{let R=m.totalBytes??p.totalBytes??0;if(R>0&&!await nt(R)){await g(p.id,{status:l.DEFERRED,deferredReason:"insufficient-storage"}),u("deferred",{id:p.id,reason:"insufficient-storage"});return}await Ct(m)})().finally(()=>{d.delete(E),c()});d.add(E),c()}c()})}function mt({concurrency:t=_t}={}){b||(b=!0,(async()=>{for(;b;){if(!P()){let e=await D(i.DOWNLOAD_QUEUE);for(let n of e)n.status===l.IN_PROGRESS&&(y.get(n.id)?.abort(),y.delete(n.id),await g(n.id,{status:l.PAUSED,deferredReason:"network-offline"}));u("connectivity",{online:!1}),await ct();continue}await Ft(t),b&&await ct()}})())}async function z(){b=!1,S(),await h(),u("stopped",{})}async function wt(){let t=await D(i.DOWNLOAD_QUEUE);for(let e of t)e.status===l.FAILED&&await g(e.id,{status:l.PENDING,retryCount:0,errorMessage:null});S()}function gt(){return b}async function F(t){y.get(t)?.abort(),y.delete(t)}async function h(){for(let[t,e]of y)e.abort(),y.delete(t)}function yt(){st({pauseAll:h,resumeAll:S})}var l={PENDING:"pending",IN_PROGRESS:"in-progress",PAUSED:"paused",COMPLETE:"complete",EXPIRED:"expired",FAILED:"failed",DEFERRED:"deferred"},j=new Set([l.COMPLETE,l.EXPIRED]);function qt(t){if(!t||typeof t!="object")throw new Error("Registry entry must be an object.");if(!t.id||typeof t.id!="string")throw new Error('Registry entry must have a string "id".');if(!t.downloadUrl||typeof t.downloadUrl!="string")throw new Error(`Entry "${t.id}" must have a string "downloadUrl".`);if(t.mimeType!==void 0&&t.mimeType!==null&&typeof t.mimeType!="string")throw new Error(`Entry "${t.id}" mimeType must be a string or omitted.`);if(typeof t.version!="number"||!Number.isInteger(t.version)||t.version<0)throw new Error(`Entry "${t.id}" version must be a non-negative integer.`);if(t.ttl!==void 0&&(typeof t.ttl!="number"||t.ttl<0))throw new Error(`Entry "${t.id}" ttl must be a non-negative number (seconds).`)}function Rt(t){return{id:t,status:l.PENDING,data:null,bytesDownloaded:0,totalBytes:null,byteOffset:0,retryCount:0,lastAttemptAt:null,errorMessage:null,deferredReason:null,completedAt:null,expiresAt:null}}async function q(t,e){let n=await f(i.REGISTRY,t);n&&await w(i.REGISTRY,{...n,...e})}function Et(t,e){return e?t+e*1e3:null}function jt(t){return t?Date.now()>=t:!1}async function H(t){try{qt(t);let e=Date.now(),n=await f(i.REGISTRY,t.id),r=await f(i.DOWNLOAD_QUEUE,t.id),o={id:t.id,downloadUrl:t.downloadUrl,mimeType:t.mimeType??null,version:t.version,protected:t.protected??!1,priority:t.priority??10,ttl:t.ttl??0,totalBytes:t.totalBytes??null,metadata:t.metadata??{},registeredAt:n?.registeredAt??e,updatedAt:e,...n?{}:{status:l.PENDING,bytesDownloaded:0,retryCount:0,lastAttemptAt:null,errorMessage:null,deferredReason:null,completedAt:null,expiresAt:null}};if(n){if(t.version>n.version){await w(i.REGISTRY,o);let a=r?{...r,status:l.PENDING,bytesDownloaded:0,byteOffset:0,retryCount:0,errorMessage:null,deferredReason:null,completedAt:null,expiresAt:null}:Rt(t.id);await w(i.DOWNLOAD_QUEUE,a),await q(t.id,{status:l.PENDING,bytesDownloaded:0,retryCount:0,errorMessage:null,deferredReason:null,completedAt:null,expiresAt:null}),u("registered",{id:t.id,reason:"version-updated"}),S()}return}await w(i.REGISTRY,o),await w(i.DOWNLOAD_QUEUE,Rt(t.id)),u("registered",{id:t.id,reason:"new"}),S()}catch(e){if(e?.name==="QuotaExceededError"){u("error",{id,reason:"insufficient-storage",willRetry:!1});return}else u("error",{id,reason:e?.message??e,willRetry:!1})}}async function xt(t){if(!Array.isArray(t))throw new Error("registerFiles expects an array.");let e=new Set(t.map(o=>o.id)),n=await D(i.REGISTRY),r=[];for(let o of n)!e.has(o.id)&&!o.protected&&(await A(i.REGISTRY,o.id),await A(i.DOWNLOAD_QUEUE,o.id),r.push(o.id),u("deleted",{id:o.id,registryRemoved:!0}));for(let o of t)await H(o);return{registered:t.map(o=>o.id),removed:r}}async function Wt(t,e){try{if(t&&e){let n=await f(i.REGISTRY,entry.id);n&&(n.metadata={...n.metadata??{},...e},await w(i.REGISTRY,n))}}catch(n){if(n?.name==="QuotaExceededError"){u("error",{id:t,reason:"insufficient-storage",willRetry:!1});return}else u("error",{id:t,reason:n?.message??n,willRetry:!1})}}async function Dt(){let t=await D(i.DOWNLOAD_QUEUE),e=[];for(let n of t)n.status===l.COMPLETE&&jt(n.expiresAt)&&(await w(i.DOWNLOAD_QUEUE,{...n,status:l.EXPIRED}),await q(n.id,{status:l.EXPIRED}),e.push(n.id),u("expired",{id:n.id}));return e}async function bt(){let[t,e]=await Promise.all([D(i.REGISTRY),I()]);return{items:t.map(r=>St(r)).sort((r,o)=>r.priority-o.priority),storage:{usageBytes:e.usage,quotaBytes:e.quota,availableBytes:e.available,usageFormatted:G(e.usage),quotaFormatted:G(e.quota),availableFormatted:G(e.available)}}}async function At(t){let e=await f(i.REGISTRY,t);return e?St(e):null}function St(t){return{id:t.id,downloadUrl:t.downloadUrl,mimeType:t.mimeType??null,version:t.version,protected:t.protected,priority:t.priority,ttl:t.ttl,totalBytes:t.totalBytes,metadata:t.metadata,registeredAt:t.registeredAt,updatedAt:t.updatedAt,downloadStatus:t.status??null,bytesDownloaded:t.bytesDownloaded??0,progress:t.totalBytes&&t.bytesDownloaded?Math.round(t.bytesDownloaded/t.totalBytes*100):null,retryCount:t.retryCount??0,lastAttemptAt:t.lastAttemptAt??null,errorMessage:t.errorMessage??null,deferredReason:t.deferredReason??null,completedAt:t.completedAt??null,expiresAt:t.expiresAt??null}}async function ht(t){let e=await f(i.REGISTRY,t);if(e?.status)return j.has(e?.status);let n=await f(i.DOWNLOAD_QUEUE,t);return j.has(n?.status)}async function Yt(t){let e=await f(i.DOWNLOAD_QUEUE,t);e&&await w(i.DOWNLOAD_QUEUE,{...e,status:l.PENDING,data:null,bytesDownloaded:0,byteOffset:0,retryCount:0,errorMessage:null,deferredReason:null,completedAt:null,expiresAt:null})}async function X(t,{removeProtected:e=!1}={}){let n=await f(i.REGISTRY,t);if(!n)throw new Error(`deleteFile: No registered file with id "${t}".`);await F(t);let r=e||!n.protected;return r?(await A(i.REGISTRY,t),await A(i.DOWNLOAD_QUEUE,t)):await Yt(t),u("deleted",{id:t,registryRemoved:r}),{id:t,registryRemoved:r}}async function Ot({removeProtected:t=!1}={}){await h();let e=await N(i.REGISTRY);return Promise.all(e.map(n=>X(n,{removeProtected:t})))}async function kt(t){let[e,n]=await Promise.all([f(i.REGISTRY,t),f(i.DOWNLOAD_QUEUE,t)]);if(!e)throw new Error(`retrieve: No registered file with id "${t}".`);if(!j.has(n?.status)||!n?.data)throw new Error(`retrieve: File "${t}" has no data yet (status: ${n?.status??"unknown"}).`);return{data:n.data,mimeType:n.mimeType}}var $t={setDBInfo:tt,dbGetAllIds:N,registerFile:H,registerFiles:xt,startDownloads:mt,stopDownloads:z,retryFailed:wt,isDownloading:gt,abortDownload:F,abortAllDownloads:h,startMonitoring:yt,stopMonitoring:k,isOnline:P,isMonitoring:$,updateConnectivityStatus:lt,retrieve:kt,getAllStatus:bt,getStatus:At,isReady:ht,delete:X,deleteAll:Ot,on:W,off:M,once:et,getStorageEstimate:I,requestPersistentStorage:ot,isPersistentStorage:rt},Oe=$t;export{h as abortAllDownloads,F as abortDownload,Oe as default,Ot as deleteAllFiles,X as deleteFile,u as emit,bt as getAllStatus,At as getStatus,I as getStorageEstimate,gt as isDownloading,$ as isMonitoring,P as isOnline,rt as isPersistentStorage,ht as isReady,M as off,W as on,et as once,H as registerFile,xt as registerFiles,ot as requestPersistentStorage,kt as retrieve,wt as retryFailed,mt as startDownloads,yt as startMonitoring,z as stopDownloads,k as stopMonitoring,lt as updateConnectivityStatus,Wt as updateRegistryMetadata};
