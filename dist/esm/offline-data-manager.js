var K="offline-data-manager",z=1,L=null,i={REGISTRY:"registry",DOWNLOAD_QUEUE:"downloadQueue"};async function V(t,e){K=t??"offline-data-manager",z=e??1}async function U(){return L||(L=await new Promise((t,e)=>{let o=indexedDB.open(K,z);o.onupgradeneeded=a=>{let r=a.target.result;if(!r.objectStoreNames.contains(i.REGISTRY)){let n=r.createObjectStore(i.REGISTRY,{keyPath:"id"});n.createIndex("protected","protected",{unique:!1}),n.createIndex("priority","priority",{unique:!1})}if(!r.objectStoreNames.contains(i.DOWNLOAD_QUEUE)){let n=r.createObjectStore(i.DOWNLOAD_QUEUE,{keyPath:"id"});n.createIndex("status","status",{unique:!1}),n.createIndex("priority","priority",{unique:!1})}},o.onsuccess=()=>t(o.result),o.onerror=()=>e(o.error)}),L)}async function p(t,e){let o=await U();return new Promise((a,r)=>{let n=o.transaction(t,"readonly").objectStore(t).get(e);n.onsuccess=()=>a(n.result),n.onerror=()=>r(n.error)})}async function y(t){let e=await U();return new Promise((o,a)=>{let r=e.transaction(t,"readonly").objectStore(t).getAll();r.onsuccess=()=>o(r.result),r.onerror=()=>a(r.error)})}async function N(t){let e=await U();return new Promise((o,a)=>{let r=e.transaction(t,"readonly").objectStore(t).getAllKeys();r.onsuccess=()=>o(r.result),r.onerror=()=>a(r.error)})}async function g(t,e){let o=await U();return new Promise((a,r)=>{let n=o.transaction(t,"readwrite").objectStore(t).put(e);n.onsuccess=()=>a(),n.onerror=()=>r(n.error)})}async function S(t,e){let o=await U();return new Promise((a,r)=>{let n=o.transaction(t,"readwrite").objectStore(t).delete(e);n.onsuccess=()=>a(),n.onerror=()=>r(n.error)})}var T=new Map;function Q(t,e){return T.has(t)||T.set(t,new Set),T.get(t).add(e),()=>_(t,e)}function _(t,e){T.get(t)?.delete(e)}function d(t,e){T.get(t)?.forEach(o=>{try{o(e)}catch(a){console.error(`[offline-data-manager] Error in "${t}" listener:`,a)}})}function Z(t,e){let o=a=>{e(a),_(t,o)};Q(t,o)}async function I(){if(!navigator?.storage?.estimate)return{usage:0,quota:1/0,available:1/0};let{usage:t=0,quota:e=1/0}=await navigator.storage.estimate();return{usage:t,quota:e,available:e-t}}async function J(t){let{available:e,quota:o}=await I();return e-o*.1>=t}async function tt(){return navigator?.storage?.persist?navigator.storage.persist():!1}async function et(){return navigator?.storage?.persisted?navigator.storage.persisted():!1}function P(t){return t===1/0?"\u221E":t<1024?`${t} B`:t<1024**2?`${(t/1024).toFixed(1)} KB`:t<1024**3?`${(t/1024**2).toFixed(1)} MB`:`${(t/1024**3).toFixed(2)} GB`}var F=null,q=null,M=!1;function ot(){d("connectivity",{online:!1}),F?.()}function nt(){d("connectivity",{online:!0}),q?.()}function rt({pauseAll:t,resumeAll:e}){M||(F=t,q=e,window.addEventListener("offline",ot),window.addEventListener("online",nt),M=!0)}function W(){window.removeEventListener("offline",ot),window.removeEventListener("online",nt),F=null,q=null,M=!1}function v(){return navigator.onLine??!0}function $(){return M}var St=2*1024*1024,Ot=5*1024*1024,ht=2,at=5,xt=1e3,E=new Map,b=!1,G=null;function st(){return new Promise(t=>{G=t})}function O(){if(G){let t=G;G=null,t()}}var Ut=t=>new Promise(e=>setTimeout(e,t)),Tt=t=>xt*Math.pow(2,t);async function m(t,e){let o=await p(i.DOWNLOAD_QUEUE,t);o&&await g(i.DOWNLOAD_QUEUE,{...o,...e})}async function It(t,e){try{let o=await fetch(t,{method:"HEAD",signal:e}),a=o.headers.get("Accept-Ranges")==="bytes",r=o.headers.get("Content-Encoding"),n=!!r&&r!=="identity",s=o.headers.get("Content-Length"),l=s&&!n?parseInt(s,10):null,c=it(o.headers.get("Content-Type"));return{supportsRange:a,totalBytes:l,mimeType:c}}catch{return{supportsRange:!1,totalBytes:null,mimeType:null}}}function it(t){return t&&t.split(";")[0].trim()||null}function lt(t){let e=t.reduce((r,n)=>r+n.byteLength,0),o=new Uint8Array(e),a=0;for(let r of t)o.set(r,a),a+=r.byteLength;return o}async function vt(t){let{id:e,downloadUrl:o,ttl:a}=t,r=new AbortController;E.set(e,r);let n=await p(i.DOWNLOAD_QUEUE,e),s=n?.retryCount??0;for(;s<=at;)try{await m(e,{status:u.IN_PROGRESS,lastAttemptAt:Date.now(),retryCount:s,errorMessage:null}),d("status",{id:e,status:u.IN_PROGRESS}),n=await p(i.DOWNLOAD_QUEUE,e);let l=n?.byteOffset??0,c=!1,f=n?.totalBytes??t.totalBytes??null,w=t.mimeType??null;if(l===0){let R=await It(o,r.signal);c=R.supportsRange,R.totalBytes&&(f=R.totalBytes,await m(e,{totalBytes:f})),!w&&R.mimeType&&(w=R.mimeType)}else c=!0;let D=c&&f&&f>Ot,A,x=null;if(D)A=await Nt(e,o,l,f,r.signal);else{let R=await Lt(e,o,r.signal);A=R.uint8,x=R.mimeType}let H=w??x??"application/octet-stream",C=A.buffer,X=Date.now(),bt=wt(X,a);await m(e,{status:u.COMPLETE,data:C,mimeType:H,bytesDownloaded:C.byteLength,byteOffset:C.byteLength,completedAt:X,expiresAt:bt,errorMessage:null,deferredReason:null}),d("complete",{id:e,mimeType:H}),E.delete(e);return}catch(l){if(l.name==="AbortError"){await m(e,{status:u.PAUSED}),d("status",{id:e,status:u.PAUSED}),E.delete(e);return}if(s++,s>at){await m(e,{status:u.FAILED,retryCount:s,errorMessage:l.message}),d("error",{id:e,error:l,retryCount:s}),E.delete(e);return}let c=Tt(s-1);console.warn(`[offline-data-manager] "${e}" failed (attempt ${s}), retrying in ${c}ms:`,l.message),d("error",{id:e,error:l,retryCount:s,willRetry:!0}),await m(e,{status:u.PENDING,retryCount:s,errorMessage:l.message}),await Ut(c)}}async function Lt(t,e,o){let a=await fetch(e,{signal:o});if(!a.ok)throw new Error(`HTTP ${a.status} ${a.statusText}`);let r=a.headers.get("Content-Encoding"),n=!!r&&r!=="identity",s=a.headers.get("Content-Length"),l=s&&!n?parseInt(s,10):null,c=it(a.headers.get("Content-Type")),f=a.body.getReader(),w=[],D=0;for(;;){let{done:A,value:x}=await f.read();if(A)break;w.push(x),D+=x.byteLength,await m(t,{bytesDownloaded:D,totalBytes:l}),d("progress",{id:t,bytesDownloaded:D,totalBytes:l,percent:l?Math.round(D/l*100):null})}return{uint8:lt(w),mimeType:c}}async function Nt(t,e,o,a,r){let n=o,s=[],l=o;for(;n<a;){let c=Math.min(n+St-1,a-1),f=await fetch(e,{signal:r,headers:{Range:`bytes=${n}-${c}`}});if(!f.ok&&f.status!==206)throw new Error(`HTTP ${f.status} on Range bytes=${n}-${c}`);let w=new Uint8Array(await f.arrayBuffer());s.push(w),n+=w.byteLength,l+=w.byteLength,await m(t,{bytesDownloaded:l,byteOffset:n}),d("progress",{id:t,bytesDownloaded:l,totalBytes:a,percent:Math.round(l/a*100)})}return lt(s)}async function _t(t){await mt();let[e,o]=await Promise.all([y(i.REGISTRY),y(i.DOWNLOAD_QUEUE)]),a=new Map(e.map(l=>[l.id,l])),r=o.filter(l=>[u.PENDING,u.IN_PROGRESS,u.PAUSED,u.DEFERRED,u.EXPIRED].includes(l.status)).sort((l,c)=>(a.get(l.id)?.priority??10)-(a.get(c.id)?.priority??10));if(r.length===0)return;let n=[...r],s=new Set;await new Promise(l=>{function c(){if(!b){l();return}if(n.length===0){s.size===0&&l();return}if(s.size>=t)return;let f=n.shift(),w=a.get(f.id);if(!w){c();return}let D=(async()=>{let A=w.totalBytes??f.totalBytes??0;if(A>0&&!await J(A)){await m(f.id,{status:u.DEFERRED,deferredReason:"insufficient-storage"}),d("deferred",{id:f.id,reason:"insufficient-storage"});return}await vt(w)})().finally(()=>{s.delete(D),c()});s.add(D),c()}c()})}function ut({concurrency:t=ht}={}){b||(b=!0,(async()=>{for(;b;){if(!v()){let e=await y(i.DOWNLOAD_QUEUE);for(let o of e)o.status===u.IN_PROGRESS&&(E.get(o.id)?.abort(),E.delete(o.id),await m(o.id,{status:u.PAUSED,deferredReason:"network-offline"}));d("connectivity",{online:!1}),await st();continue}await _t(t),b&&await st()}})())}async function dt(){b=!1,O(),await h(),d("stopped",{})}async function ct(){let t=await y(i.DOWNLOAD_QUEUE);for(let e of t)e.status===u.FAILED&&await m(e.id,{status:u.PENDING,retryCount:0,errorMessage:null});O()}function ft(){return b}async function B(t){E.get(t)?.abort(),E.delete(t)}async function h(){for(let[t,e]of E)e.abort(),E.delete(t)}function pt(){rt({pauseAll:h,resumeAll:O})}var u={PENDING:"pending",IN_PROGRESS:"in-progress",PAUSED:"paused",COMPLETE:"complete",EXPIRED:"expired",FAILED:"failed",DEFERRED:"deferred"},k=new Set([u.COMPLETE,u.EXPIRED]);function Pt(t){if(!t||typeof t!="object")throw new Error("Registry entry must be an object.");if(!t.id||typeof t.id!="string")throw new Error('Registry entry must have a string "id".');if(!t.downloadUrl||typeof t.downloadUrl!="string")throw new Error(`Entry "${t.id}" must have a string "downloadUrl".`);if(t.mimeType!==void 0&&t.mimeType!==null&&typeof t.mimeType!="string")throw new Error(`Entry "${t.id}" mimeType must be a string or omitted.`);if(typeof t.version!="number"||!Number.isInteger(t.version)||t.version<0)throw new Error(`Entry "${t.id}" version must be a non-negative integer.`);if(t.ttl!==void 0&&(typeof t.ttl!="number"||t.ttl<0))throw new Error(`Entry "${t.id}" ttl must be a non-negative number (seconds).`)}function yt(t){return{id:t,status:u.PENDING,data:null,bytesDownloaded:0,totalBytes:null,byteOffset:0,retryCount:0,lastAttemptAt:null,errorMessage:null,deferredReason:null,completedAt:null,expiresAt:null}}function wt(t,e){return e?t+e*1e3:null}function Mt(t){return t?Date.now()>=t:!1}async function Y(t){Pt(t);let e=Date.now(),o=await p(i.REGISTRY,t.id),a=await p(i.DOWNLOAD_QUEUE,t.id),r={id:t.id,downloadUrl:t.downloadUrl,mimeType:t.mimeType??null,version:t.version,protected:t.protected??!1,priority:t.priority??10,ttl:t.ttl??0,totalBytes:t.totalBytes??null,metadata:t.metadata??{},registeredAt:o?.registeredAt??e,updatedAt:e};if(o){if(t.version>o.version){await g(i.REGISTRY,r);let n=a?{...a,status:u.PENDING,bytesDownloaded:0,byteOffset:0,retryCount:0,errorMessage:null,deferredReason:null,completedAt:null,expiresAt:null}:yt(t.id);await g(i.DOWNLOAD_QUEUE,n),d("registered",{id:t.id,reason:"version-updated"}),O()}return}await g(i.REGISTRY,r),await g(i.DOWNLOAD_QUEUE,yt(t.id)),d("registered",{id:t.id,reason:"new"}),O()}async function gt(t){if(!Array.isArray(t))throw new Error("registerFiles expects an array.");let e=new Set(t.map(r=>r.id)),o=await y(i.REGISTRY),a=[];for(let r of o)!e.has(r.id)&&!r.protected&&(await S(i.REGISTRY,r.id),await S(i.DOWNLOAD_QUEUE,r.id),a.push(r.id),d("deleted",{id:r.id,registryRemoved:!0}));for(let r of t)await Y(r);return{registered:t.map(r=>r.id),removed:a}}async function mt(){let t=await y(i.DOWNLOAD_QUEUE),e=[];for(let o of t)o.status===u.COMPLETE&&Mt(o.expiresAt)&&(await g(i.DOWNLOAD_QUEUE,{...o,status:u.EXPIRED}),e.push(o.id),d("expired",{id:o.id}));return e}async function Et(){let[t,e,o]=await Promise.all([y(i.REGISTRY),y(i.DOWNLOAD_QUEUE),I()]),a=new Map(e.map(n=>[n.id,n]));return{items:t.map(n=>{let s=a.get(n.id)??null;return{id:n.id,downloadUrl:n.downloadUrl,mimeType:n.mimeType,version:n.version,protected:n.protected,priority:n.priority,ttl:n.ttl,totalBytes:n.totalBytes,metadata:n.metadata,registeredAt:n.registeredAt,updatedAt:n.updatedAt,downloadStatus:s?.status??null,bytesDownloaded:s?.bytesDownloaded??0,storedBytes:s?.data?.length??null,progress:s?.totalBytes&&s?.bytesDownloaded?Math.round(s.bytesDownloaded/s.totalBytes*100):null,retryCount:s?.retryCount??0,lastAttemptAt:s?.lastAttemptAt??null,errorMessage:s?.errorMessage??null,deferredReason:s?.deferredReason??null,completedAt:s?.completedAt??null,expiresAt:s?.expiresAt??null}}).sort((n,s)=>n.priority-s.priority),storage:{usageBytes:o.usage,quotaBytes:o.quota,availableBytes:o.available,usageFormatted:P(o.usage),quotaFormatted:P(o.quota),availableFormatted:P(o.available)}}}async function Dt(t){let[e,o]=await Promise.all([p(i.REGISTRY,t),p(i.DOWNLOAD_QUEUE,t)]);return e?{id:e.id,downloadUrl:e.downloadUrl,mimeType:e.mimeType??null,version:e.version,protected:e.protected,priority:e.priority,ttl:e.ttl,totalBytes:e.totalBytes,metadata:e.metadata,registeredAt:e.registeredAt,updatedAt:e.updatedAt,downloadStatus:o?.status??null,bytesDownloaded:o?.bytesDownloaded??0,storedBytes:o?.data?.length??null,progress:o?.totalBytes&&o?.bytesDownloaded?Math.round(o.bytesDownloaded/o.totalBytes*100):null,retryCount:o?.retryCount??0,lastAttemptAt:o?.lastAttemptAt??null,errorMessage:o?.errorMessage??null,deferredReason:o?.deferredReason??null,completedAt:o?.completedAt??null,expiresAt:o?.expiresAt??null}:null}async function At(t){let e=await p(i.DOWNLOAD_QUEUE,t);return k.has(e?.status)}async function Gt(t){let e=await p(i.DOWNLOAD_QUEUE,t);e&&await g(i.DOWNLOAD_QUEUE,{...e,status:u.PENDING,data:null,bytesDownloaded:0,byteOffset:0,retryCount:0,errorMessage:null,deferredReason:null,completedAt:null,expiresAt:null})}async function j(t,{removeProtected:e=!1}={}){let o=await p(i.REGISTRY,t);if(!o)throw new Error(`deleteFile: No registered file with id "${t}".`);await B(t);let a=e||!o.protected;return a?(await S(i.REGISTRY,t),await S(i.DOWNLOAD_QUEUE,t)):await Gt(t),d("deleted",{id:t,registryRemoved:a}),{id:t,registryRemoved:a}}async function Rt({removeProtected:t=!1}={}){await h();let e=await N(i.REGISTRY);return Promise.all(e.map(o=>j(o,{removeProtected:t})))}async function Bt(t){let[e,o]=await Promise.all([p(i.REGISTRY,t),p(i.DOWNLOAD_QUEUE,t)]);if(!e)throw new Error(`retrieve: No registered file with id "${t}".`);if(!k.has(o?.status)||!o?.data)throw new Error(`retrieve: File "${t}" has no data yet (status: ${o?.status??"unknown"}).`);return{data:o.data,mimeType:o.mimeType}}var Ct={setDBInfo:V,dbGetAllIds:N,registerFile:Y,registerFiles:gt,startDownloads:ut,stopDownloads:dt,retryFailed:ct,isDownloading:ft,abortDownload:B,abortAllDownloads:h,startMonitoring:pt,stopMonitoring:W,isOnline:v,isMonitoring:$,retrieve:Bt,getAllStatus:Et,getStatus:Dt,isReady:At,delete:j,deleteAll:Rt,on:Q,off:_,once:Z,getStorageEstimate:I,requestPersistentStorage:tt,isPersistentStorage:et},me=Ct;export{h as abortAllDownloads,B as abortDownload,me as default,Rt as deleteAllFiles,j as deleteFile,d as emit,Et as getAllStatus,Dt as getStatus,I as getStorageEstimate,ft as isDownloading,$ as isMonitoring,v as isOnline,et as isPersistentStorage,At as isReady,_ as off,Q as on,Z as once,Y as registerFile,gt as registerFiles,tt as requestPersistentStorage,Bt as retrieve,ct as retryFailed,ut as startDownloads,pt as startMonitoring,dt as stopDownloads,W as stopMonitoring};
