var Z="offline-data-manager",J=1,_=null,s={REGISTRY:"registry",DOWNLOAD_QUEUE:"downloadQueue"};async function tt(t,e){Z=t??"offline-data-manager",J=e??1}async function T(){return _||(_=await new Promise((t,e)=>{let r=indexedDB.open(Z,J);r.onupgradeneeded=o=>{let n=o.target.result;if(!n.objectStoreNames.contains(s.REGISTRY)){let a=n.createObjectStore(s.REGISTRY,{keyPath:"id"});a.createIndex("protected","protected",{unique:!1}),a.createIndex("priority","priority",{unique:!1})}if(!n.objectStoreNames.contains(s.DOWNLOAD_QUEUE)){let a=n.createObjectStore(s.DOWNLOAD_QUEUE,{keyPath:"id"});a.createIndex("status","status",{unique:!1}),a.createIndex("priority","priority",{unique:!1})}},r.onsuccess=()=>t(r.result),r.onerror=()=>e(r.error)}),_)}async function f(t,e){let r=await T();return new Promise((o,n)=>{let a=r.transaction(t,"readonly").objectStore(t).get(e);a.onsuccess=()=>o(a.result),a.onerror=()=>n(a.error)})}async function D(t){let e=await T();return new Promise((r,o)=>{let n=e.transaction(t,"readonly").objectStore(t).getAll();n.onsuccess=()=>r(n.result),n.onerror=()=>o(n.error)})}async function L(t){let e=await T();return new Promise((r,o)=>{let n=e.transaction(t,"readonly").objectStore(t).getAllKeys();n.onsuccess=()=>r(n.result),n.onerror=()=>o(n.error)})}async function m(t,e){let r=await T();return new Promise((o,n)=>{let a=r.transaction(t,"readwrite").objectStore(t).put(e);a.onsuccess=()=>o(),a.onerror=()=>n(a.error),a.onerror=()=>n(a.error)})}async function S(t,e){let r=await T();return new Promise((o,n)=>{let a=r.transaction(t,"readwrite").objectStore(t).delete(e);a.onsuccess=()=>o(),a.onerror=()=>n(a.error)})}var U=new Map;function Y(t,e){return U.has(t)||U.set(t,new Set),U.get(t).add(e),()=>G(t,e)}function G(t,e){U.get(t)?.delete(e)}function u(t,e){U.get(t)?.forEach(r=>{try{r(e)}catch(o){console.error(`[offline-data-manager] Error in "${t}" listener:`,o)}})}function et(t,e){let r=o=>{e(o),G(t,r)};Y(t,r)}async function I(){if(!navigator?.storage?.estimate)return{usage:0,quota:1/0,available:1/0};let{usage:t=0,quota:e=1/0}=await navigator.storage.estimate();return{usage:t,quota:e,available:e-t}}async function rt(t){let{available:e,quota:r}=await I();return e-r*.1>=t}async function nt(){return navigator?.storage?.persist?navigator.storage.persist():!1}async function ot(){return navigator?.storage?.persisted?navigator.storage.persisted():!1}function M(t){return t===1/0?"\u221E":t<1024?`${t} B`:t<1024**2?`${(t/1024).toFixed(1)} KB`:t<1024**3?`${(t/1024**2).toFixed(1)} MB`:`${(t/1024**3).toFixed(2)} GB`}var C=null,Q=null,N=!1,$=!0;function at(){u("connectivity",{online:!1}),C?.()}function st(){u("connectivity",{online:!0}),Q?.()}function it({pauseAll:t,resumeAll:e}){N||(C=t,Q=e,window&&(window.addEventListener("offline",at),window.addEventListener("online",st)),N=!0)}function k(){globalThis.window&&(window.removeEventListener("offline",at),window.removeEventListener("online",st)),C=null,Q=null,N=!1}function v(){return globalThis.window?navigator.onLine??!0:$}function j(){return N}function lt(t){$=t,N&&($?Q?.():C?.())}var Tt=2*1024*1024,Ut=5*1024*1024,It=2,ut=5,Nt=1e3,E=new Map,b=!1,F=null;function dt(){return new Promise(t=>{F=t})}function h(){if(F){let t=F;F=null,t()}}var vt=t=>new Promise(e=>setTimeout(e,t)),Pt=t=>Nt*Math.pow(2,t);async function y(t,e){let r=await f(s.DOWNLOAD_QUEUE,t);if(!r)return;await m(s.DOWNLOAD_QUEUE,{...r,...e});let{data:o,...n}=e;Object.keys(n).length>0&&await W(t,n)}async function _t(t,e){try{let r=await fetch(t,{method:"HEAD",signal:e}),o=r.headers.get("Accept-Ranges")==="bytes",n=r.headers.get("Content-Encoding"),a=!!n&&n!=="identity",d=r.headers.get("Content-Length"),i=d&&!a?parseInt(d,10):null,c=ct(r.headers.get("Content-Type"));return{supportsRange:o,totalBytes:i,mimeType:c}}catch{return{supportsRange:!1,totalBytes:null,mimeType:null}}}function ct(t){return t&&t.split(";")[0].trim()||null}function ft(t){let e=t.reduce((n,a)=>n+a.byteLength,0),r=new Uint8Array(e),o=0;for(let n of t)r.set(n,o),o+=n.byteLength;return r}async function Lt(t){let{id:e,downloadUrl:r,ttl:o}=t,n=new AbortController;E.set(e,n);let a=await f(s.DOWNLOAD_QUEUE,e),d=a?.retryCount??0;for(;d<=ut;)try{await y(e,{status:l.IN_PROGRESS,lastAttemptAt:Date.now(),retryCount:d,errorMessage:null}),u("status",{id:e,status:l.IN_PROGRESS}),a=await f(s.DOWNLOAD_QUEUE,e);let i=a?.byteOffset??0,c=!1,p=a?.totalBytes??t.totalBytes??null,w=t.mimeType??null;if(i===0){let A=await _t(r,n.signal);c=A.supportsRange,A.totalBytes&&(p=A.totalBytes,await y(e,{totalBytes:p})),!w&&A.mimeType&&(w=A.mimeType)}else c=!0;let g=c&&p&&p>Ut,R,O=null;if(g)R=await Mt(e,r,i,p,n.signal);else{let A=await Gt(e,r,n.signal);R=A.uint8,O=A.mimeType}let z=w??O??"application/octet-stream",P=R.buffer,V=Date.now(),Ot=Et(V,o);await y(e,{status:l.COMPLETE,data:P,mimeType:z,bytesDownloaded:P.byteLength,byteOffset:P.byteLength,storedBytes:P?.byteLength,completedAt:V,expiresAt:Ot,errorMessage:null,deferredReason:null}),u("complete",{id:e,mimeType:z}),E.delete(e);return}catch(i){if(i?.name==="QuotaExceededError"){await H(),await y(e,{status:l.DEFERRED,deferredReason:"insufficient-storage"}),u("error",{id:e,reason:"insufficient-storage",willRetry:!1});return}else if(i?.name==="AbortError"){await y(e,{status:l.PAUSED}),u("status",{id:e,status:l.PAUSED}),E.delete(e);return}if(d++,d>ut){await y(e,{status:l.FAILED,retryCount:d,errorMessage:i.message}),u("error",{id:e,error:i,retryCount:d}),E.delete(e);return}let c=Pt(d-1);console.warn(`[offline-data-manager] "${e}" failed (attempt ${d}), retrying in ${c}ms:`,i.message),u("error",{id:e,error:i,retryCount:d,willRetry:!0}),await y(e,{status:l.PENDING,retryCount:d,errorMessage:i.message}),await vt(c)}}async function Gt(t,e,r){let o=await fetch(e,{signal:r});if(!o.ok)throw new Error(`HTTP ${o.status} ${o.statusText}`);let n=o.headers.get("Content-Encoding"),a=!!n&&n!=="identity",d=o.headers.get("Content-Length"),i=d&&!a?parseInt(d,10):null,c=ct(o.headers.get("Content-Type")),p=o.body.getReader(),w=[],g=0;for(;;){let{done:R,value:O}=await p.read();if(R)break;w.push(O),g+=O.byteLength,await y(t,{bytesDownloaded:g,totalBytes:i}),u("progress",{id:t,bytesDownloaded:g,totalBytes:i,percent:i?Math.round(g/i*100):null})}return{uint8:ft(w),mimeType:c}}async function Mt(t,e,r,o,n){let a=r,d=[],i=r;for(;a<o;){let c=Math.min(a+Tt-1,o-1),p=await fetch(e,{signal:n,headers:{Range:`bytes=${a}-${c}`}});if(!p.ok&&p.status!==206)throw new Error(`HTTP ${p.status} on Range bytes=${a}-${c}`);let w=new Uint8Array(await p.arrayBuffer());d.push(w),a+=w.byteLength,i+=w.byteLength,await y(t,{bytesDownloaded:i,byteOffset:a}),u("progress",{id:t,bytesDownloaded:i,totalBytes:o,percent:Math.round(i/o*100)})}return ft(d)}async function Ct(t){await gt();let[e,r]=await Promise.all([D(s.REGISTRY),D(s.DOWNLOAD_QUEUE)]),o=new Map(e.map(i=>[i.id,i])),n=r.filter(i=>[l.PENDING,l.IN_PROGRESS,l.PAUSED,l.DEFERRED,l.EXPIRED].includes(i.status)).sort((i,c)=>(o.get(i.id)?.priority??10)-(o.get(c.id)?.priority??10));if(n.length===0)return;let a=[...n],d=new Set;await new Promise(i=>{function c(){if(!b){i();return}if(a.length===0){d.size===0&&i();return}if(d.size>=t)return;let p=a.shift(),w=o.get(p.id);if(!w){c();return}let g=(async()=>{let R=w.totalBytes??p.totalBytes??0;if(R>0&&!await rt(R)){await y(p.id,{status:l.DEFERRED,deferredReason:"insufficient-storage"}),u("deferred",{id:p.id,reason:"insufficient-storage"});return}await Lt(w)})().finally(()=>{d.delete(g),c()});d.add(g),c()}c()})}function pt({concurrency:t=It}={}){b||(b=!0,(async()=>{for(;b;){if(!v()){let e=await D(s.DOWNLOAD_QUEUE);for(let r of e)r.status===l.IN_PROGRESS&&(E.get(r.id)?.abort(),E.delete(r.id),await y(r.id,{status:l.PAUSED,deferredReason:"network-offline"}));u("connectivity",{online:!1}),await dt();continue}await Ct(t),b&&await dt()}})())}async function H(){b=!1,h(),await x(),u("stopped",{})}async function wt(){let t=await D(s.DOWNLOAD_QUEUE);for(let e of t)e.status===l.FAILED&&await y(e.id,{status:l.PENDING,retryCount:0,errorMessage:null});h()}function mt(){return b}async function B(t){E.get(t)?.abort(),E.delete(t)}async function x(){for(let[t,e]of E)e.abort(),E.delete(t)}function yt(){it({pauseAll:x,resumeAll:h})}var l={PENDING:"pending",IN_PROGRESS:"in-progress",PAUSED:"paused",COMPLETE:"complete",EXPIRED:"expired",FAILED:"failed",DEFERRED:"deferred"},q=new Set([l.COMPLETE,l.EXPIRED]);function Qt(t){if(!t||typeof t!="object")throw new Error("Registry entry must be an object.");if(!t.id||typeof t.id!="string")throw new Error('Registry entry must have a string "id".');if(!t.downloadUrl||typeof t.downloadUrl!="string")throw new Error(`Entry "${t.id}" must have a string "downloadUrl".`);if(t.mimeType!==void 0&&t.mimeType!==null&&typeof t.mimeType!="string")throw new Error(`Entry "${t.id}" mimeType must be a string or omitted.`);if(typeof t.version!="number"||!Number.isInteger(t.version)||t.version<0)throw new Error(`Entry "${t.id}" version must be a non-negative integer.`);if(t.ttl!==void 0&&(typeof t.ttl!="number"||t.ttl<0))throw new Error(`Entry "${t.id}" ttl must be a non-negative number (seconds).`)}function Dt(t){return{id:t,status:l.PENDING,data:null,bytesDownloaded:0,totalBytes:null,byteOffset:0,retryCount:0,lastAttemptAt:null,errorMessage:null,deferredReason:null,completedAt:null,expiresAt:null}}async function W(t,e){let r=await f(s.REGISTRY,t);r&&await m(s.REGISTRY,{...r,...e})}function Et(t,e){return e?t+e*1e3:null}function Ft(t){return t?Date.now()>=t:!1}async function X(t){try{Qt(t);let e=Date.now(),r=await f(s.REGISTRY,t.id),o=await f(s.DOWNLOAD_QUEUE,t.id),n={id:t.id,downloadUrl:t.downloadUrl,mimeType:t.mimeType??null,version:t.version,protected:t.protected??!1,priority:t.priority??10,ttl:t.ttl??0,totalBytes:t.totalBytes??null,metadata:t.metadata??{},registeredAt:r?.registeredAt??e,updatedAt:e,...r?{}:{status:l.PENDING,bytesDownloaded:0,retryCount:0,lastAttemptAt:null,errorMessage:null,deferredReason:null,completedAt:null,expiresAt:null}};if(r){if(t.version>r.version){await m(s.REGISTRY,n);let a=o?{...o,status:l.PENDING,bytesDownloaded:0,byteOffset:0,retryCount:0,errorMessage:null,deferredReason:null,completedAt:null,expiresAt:null}:Dt(t.id);await m(s.DOWNLOAD_QUEUE,a),await W(t.id,{status:l.PENDING,bytesDownloaded:0,retryCount:0,errorMessage:null,deferredReason:null,completedAt:null,expiresAt:null}),u("registered",{id:t.id,reason:"version-updated"}),h()}return}await m(s.REGISTRY,n),await m(s.DOWNLOAD_QUEUE,Dt(t.id)),u("registered",{id:t.id,reason:"new"}),h()}catch(e){if(e?.name==="QuotaExceededError"){u("error",{id,reason:"insufficient-storage",willRetry:!1});return}else u("error",{id,reason:e?.message??e,willRetry:!1})}}async function Rt(t){if(!Array.isArray(t))throw new Error("registerFiles expects an array.");let e=new Set(t.map(n=>n.id)),r=await D(s.REGISTRY),o=[];for(let n of r)!e.has(n.id)&&!n.protected&&(await S(s.REGISTRY,n.id),await S(s.DOWNLOAD_QUEUE,n.id),o.push(n.id),u("deleted",{id:n.id,registryRemoved:!0}));for(let n of t)await X(n);return{registered:t.map(n=>n.id),removed:o}}async function Bt(t,e){try{if(t&&e){let r=await f(s.REGISTRY,entry.id);r&&(r.metadata={...r.metadata??{},...e},await m(s.REGISTRY,r))}}catch(r){if(r?.name==="QuotaExceededError"){u("error",{id:t,reason:"insufficient-storage",willRetry:!1});return}else u("error",{id:t,reason:r?.message??r,willRetry:!1})}}async function gt(){let t=await D(s.DOWNLOAD_QUEUE),e=[];for(let r of t)r.status===l.COMPLETE&&Ft(r.expiresAt)&&(await m(s.DOWNLOAD_QUEUE,{...r,status:l.EXPIRED}),await W(r.id,{status:l.EXPIRED}),e.push(r.id),u("expired",{id:r.id}));return e}async function At(){let[t,e]=await Promise.all([D(s.REGISTRY),I()]);return{items:t.map(o=>St(o)).sort((o,n)=>o.priority-n.priority),storage:{usageBytes:e.usage,quotaBytes:e.quota,availableBytes:e.available,usageFormatted:M(e.usage),quotaFormatted:M(e.quota),availableFormatted:M(e.available)}}}async function bt(t){let e=await f(s.REGISTRY,t);return e?St(e):null}function St(t){return{id:t.id,downloadUrl:t.downloadUrl,mimeType:t.mimeType??null,version:t.version,protected:t.protected,priority:t.priority,ttl:t.ttl,totalBytes:t.totalBytes,metadata:t.metadata,registeredAt:t.registeredAt,updatedAt:t.updatedAt,downloadStatus:t.status??null,bytesDownloaded:t.bytesDownloaded??0,progress:t.totalBytes&&t.bytesDownloaded?Math.round(t.bytesDownloaded/t.totalBytes*100):null,retryCount:t.retryCount??0,lastAttemptAt:t.lastAttemptAt??null,errorMessage:t.errorMessage??null,deferredReason:t.deferredReason??null,completedAt:t.completedAt??null,expiresAt:t.expiresAt??null}}async function ht(t){let e=await f(s.REGISTRY,t);if(e?.status)return q.has(e?.status);let r=await f(s.DOWNLOAD_QUEUE,t);return q.has(r?.status)}async function Wt(t){let e=await f(s.DOWNLOAD_QUEUE,t);e&&await m(s.DOWNLOAD_QUEUE,{...e,status:l.PENDING,data:null,bytesDownloaded:0,byteOffset:0,retryCount:0,errorMessage:null,deferredReason:null,completedAt:null,expiresAt:null})}async function K(t,{removeProtected:e=!1}={}){let r=await f(s.REGISTRY,t);if(!r)throw new Error(`deleteFile: No registered file with id "${t}".`);await B(t);let o=e||!r.protected;return o?(await S(s.REGISTRY,t),await S(s.DOWNLOAD_QUEUE,t)):await Wt(t),u("deleted",{id:t,registryRemoved:o}),{id:t,registryRemoved:o}}async function xt({removeProtected:t=!1}={}){await x();let e=await L(s.REGISTRY);return Promise.all(e.map(r=>K(r,{removeProtected:t})))}async function qt(t){let[e,r]=await Promise.all([f(s.REGISTRY,t),f(s.DOWNLOAD_QUEUE,t)]);if(!e)throw new Error(`retrieve: No registered file with id "${t}".`);if(!q.has(r?.status)||!r?.data)throw new Error(`retrieve: File "${t}" has no data yet (status: ${r?.status??"unknown"}).`);return{data:r.data,mimeType:r.mimeType}}var Yt={setDBInfo:tt,dbGetAllIds:L,registerFile:X,registerFiles:Rt,startDownloads:pt,stopDownloads:H,retryFailed:wt,isDownloading:mt,abortDownload:B,abortAllDownloads:x,startMonitoring:yt,stopMonitoring:k,isOnline:v,isMonitoring:j,updateConnectivityStatus:lt,retrieve:qt,getAllStatus:At,getStatus:bt,isReady:ht,delete:K,deleteAll:xt,on:Y,off:G,once:et,getStorageEstimate:I,requestPersistentStorage:nt,isPersistentStorage:ot},Ae=Yt;export{x as abortAllDownloads,B as abortDownload,Ae as default,xt as deleteAllFiles,K as deleteFile,u as emit,At as getAllStatus,bt as getStatus,I as getStorageEstimate,mt as isDownloading,j as isMonitoring,v as isOnline,ot as isPersistentStorage,ht as isReady,G as off,Y as on,et as once,X as registerFile,Rt as registerFiles,nt as requestPersistentStorage,qt as retrieve,wt as retryFailed,pt as startDownloads,yt as startMonitoring,H as stopDownloads,k as stopMonitoring,lt as updateConnectivityStatus,Bt as updateRegistryMetadata};
