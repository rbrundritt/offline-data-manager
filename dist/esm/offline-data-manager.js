var me="offline-data-manager";var I=null,a={REGISTRY:"registry",DOWNLOAD_QUEUE:"downloadQueue"};async function N(){return I||(I=await new Promise((e,t)=>{let o=indexedDB.open(me,1);o.onupgradeneeded=s=>{let n=s.target.result;if(!n.objectStoreNames.contains(a.REGISTRY)){let r=n.createObjectStore(a.REGISTRY,{keyPath:"id"});r.createIndex("protected","protected",{unique:!1}),r.createIndex("priority","priority",{unique:!1})}if(!n.objectStoreNames.contains(a.DOWNLOAD_QUEUE)){let r=n.createObjectStore(a.DOWNLOAD_QUEUE,{keyPath:"id"});r.createIndex("status","status",{unique:!1}),r.createIndex("priority","priority",{unique:!1})}},o.onsuccess=()=>e(o.result),o.onerror=()=>t(o.error)}),I)}async function w(e,t){let o=await N();return new Promise((s,n)=>{let r=o.transaction(e,"readonly").objectStore(e).get(t);r.onsuccess=()=>s(r.result),r.onerror=()=>n(r.error)})}async function y(e){let t=await N();return new Promise((o,s)=>{let n=t.transaction(e,"readonly").objectStore(e).getAll();n.onsuccess=()=>o(n.result),n.onerror=()=>s(n.error)})}async function D(e,t){let o=await N();return new Promise((s,n)=>{let r=o.transaction(e,"readwrite").objectStore(e).put(t);r.onsuccess=()=>s(),r.onerror=()=>n(r.error)})}async function h(e,t){let o=await N();return new Promise((s,n)=>{let r=o.transaction(e,"readwrite").objectStore(e).delete(t);r.onsuccess=()=>s(),r.onerror=()=>n(r.error)})}var U=new Map;function G(e,t){return U.has(e)||U.set(e,new Set),U.get(e).add(t),()=>L(e,t)}function L(e,t){U.get(e)?.delete(t)}function f(e,t){U.get(e)?.forEach(o=>{try{o(t)}catch(s){console.error(`[offline-data-manager] Error in "${e}" listener:`,s)}})}function j(e,t){let o=s=>{t(s),L(e,o)};G(e,o)}async function x(){if(!navigator?.storage?.estimate)return{usage:0,quota:1/0,available:1/0};let{usage:e=0,quota:t=1/0}=await navigator.storage.estimate();return{usage:e,quota:t,available:t-e}}async function H(e){let{available:t,quota:o}=await x();return t-o*.1>=e}async function X(){return navigator?.storage?.persist?navigator.storage.persist():!1}async function z(){return navigator?.storage?.persisted?navigator.storage.persisted():!1}function _(e){return e===1/0?"\u221E":e<1024?`${e} B`:e<1024**2?`${(e/1024).toFixed(1)} KB`:e<1024**3?`${(e/1024**2).toFixed(1)} MB`:`${(e/1024**3).toFixed(2)} GB`}var u={PENDING:"pending",IN_PROGRESS:"in-progress",PAUSED:"paused",COMPLETE:"complete",EXPIRED:"expired",FAILED:"failed",DEFERRED:"deferred"},C=new Set([u.COMPLETE,u.EXPIRED]);function we(e){if(!e||typeof e!="object")throw new Error("Registry entry must be an object.");if(!e.id||typeof e.id!="string")throw new Error('Registry entry must have a string "id".');if(!e.downloadUrl||typeof e.downloadUrl!="string")throw new Error(`Entry "${e.id}" must have a string "downloadUrl".`);if(e.mimeType!==void 0&&e.mimeType!==null&&typeof e.mimeType!="string")throw new Error(`Entry "${e.id}" mimeType must be a string or omitted.`);if(typeof e.version!="number"||!Number.isInteger(e.version)||e.version<0)throw new Error(`Entry "${e.id}" version must be a non-negative integer.`);if(e.ttl!==void 0&&(typeof e.ttl!="number"||e.ttl<0))throw new Error(`Entry "${e.id}" ttl must be a non-negative number (seconds).`)}function K(e){return{id:e,status:u.PENDING,blob:null,bytesDownloaded:0,totalBytes:null,byteOffset:0,retryCount:0,lastAttemptAt:null,errorMessage:null,deferredReason:null,completedAt:null,expiresAt:null}}function V(e,t){return t?e+t*1e3:null}function Ee(e){return e?Date.now()>=e:!1}async function Q(e){we(e);let t=Date.now(),o=await w(a.REGISTRY,e.id),s=await w(a.DOWNLOAD_QUEUE,e.id),n={id:e.id,downloadUrl:e.downloadUrl,mimeType:e.mimeType??null,version:e.version,protected:e.protected??!1,priority:e.priority??10,ttl:e.ttl??0,totalBytes:e.totalBytes??null,metadata:e.metadata??{},registeredAt:o?.registeredAt??t,updatedAt:t};if(o){if(e.version>o.version){await D(a.REGISTRY,n);let r=s?{...s,status:u.PENDING,bytesDownloaded:0,byteOffset:0,retryCount:0,errorMessage:null,deferredReason:null,completedAt:null,expiresAt:null}:K(e.id);await D(a.DOWNLOAD_QUEUE,r),f("registered",{id:e.id,reason:"version-updated"})}return}await D(a.REGISTRY,n),await D(a.DOWNLOAD_QUEUE,K(e.id)),f("registered",{id:e.id,reason:"new"})}async function Z(e){if(!Array.isArray(e))throw new Error("registerFiles expects an array.");let t=new Set(e.map(n=>n.id)),o=await y(a.REGISTRY),s=[];for(let n of o)!t.has(n.id)&&!n.protected&&(await h(a.REGISTRY,n.id),await h(a.DOWNLOAD_QUEUE,n.id),s.push(n.id),f("deleted",{id:n.id,registryRemoved:!0}));for(let n of e)await Q(n);return{registered:e.map(n=>n.id),removed:s}}async function J(){let e=await y(a.DOWNLOAD_QUEUE),t=[];for(let o of e)o.status===u.COMPLETE&&Ee(o.expiresAt)&&(await D(a.DOWNLOAD_QUEUE,{...o,status:u.EXPIRED}),t.push(o.id),f("expired",{id:o.id}));return t}async function ee(){let[e,t,o]=await Promise.all([y(a.REGISTRY),y(a.DOWNLOAD_QUEUE),x()]),s=new Map(t.map(r=>[r.id,r]));return{items:e.map(r=>{let i=s.get(r.id)??null;return{id:r.id,downloadUrl:r.downloadUrl,mimeType:r.mimeType??i?.blob?.type??null,version:r.version,protected:r.protected,priority:r.priority,ttl:r.ttl,totalBytes:r.totalBytes,metadata:r.metadata,registeredAt:r.registeredAt,updatedAt:r.updatedAt,downloadStatus:i?.status??null,bytesDownloaded:i?.bytesDownloaded??0,storedBytes:i?.blob?.size??null,progress:i?.totalBytes&&i?.bytesDownloaded?Math.round(i.bytesDownloaded/i.totalBytes*100):null,retryCount:i?.retryCount??0,lastAttemptAt:i?.lastAttemptAt??null,errorMessage:i?.errorMessage??null,deferredReason:i?.deferredReason??null,completedAt:i?.completedAt??null,expiresAt:i?.expiresAt??null}}).sort((r,i)=>r.priority-i.priority),storage:{usageBytes:o.usage,quotaBytes:o.quota,availableBytes:o.available,usageFormatted:_(o.usage),quotaFormatted:_(o.quota),availableFormatted:_(o.available)}}}async function te(e){let[t,o]=await Promise.all([w(a.REGISTRY,e),w(a.DOWNLOAD_QUEUE,e)]);return t?{id:t.id,downloadUrl:t.downloadUrl,mimeType:t.mimeType??o?.blob?.type??null,version:t.version,protected:t.protected,priority:t.priority,ttl:t.ttl,totalBytes:t.totalBytes,metadata:t.metadata,registeredAt:t.registeredAt,updatedAt:t.updatedAt,downloadStatus:o?.status??null,bytesDownloaded:o?.bytesDownloaded??0,storedBytes:o?.blob?.size??null,progress:o?.totalBytes&&o?.bytesDownloaded?Math.round(o.bytesDownloaded/o.totalBytes*100):null,retryCount:o?.retryCount??0,lastAttemptAt:o?.lastAttemptAt??null,errorMessage:o?.errorMessage??null,deferredReason:o?.deferredReason??null,completedAt:o?.completedAt??null,expiresAt:o?.expiresAt??null}:null}async function oe(e){let t=await w(a.DOWNLOAD_QUEUE,e);return C.has(t?.status)}var F=null,q=null,P=!1;function re(){f("connectivity",{online:!1}),F?.()}function ne(){f("connectivity",{online:!0}),q?.()}function se({pauseAll:e,resumeAll:t}){P||(F=e,q=t,window.addEventListener("offline",re),window.addEventListener("online",ne),P=!0)}function W(){window.removeEventListener("offline",re),window.removeEventListener("online",ne),F=null,q=null,P=!1}function T(){return navigator.onLine??!0}function $(){return P}var ye=2*1024*1024,ge=5*1024*1024,De=2,ae=5,be=1e3,b=new Map,ie={},Ae=e=>new Promise(t=>setTimeout(t,e)),Re=e=>be*Math.pow(2,e);async function g(e,t){let o=await w(a.DOWNLOAD_QUEUE,e);o&&await D(a.DOWNLOAD_QUEUE,{...o,...t})}async function Se(e,t){try{let o=await fetch(e,{method:"HEAD",signal:t}),s=o.headers.get("Accept-Ranges")==="bytes",n=o.headers.get("Content-Encoding"),r=!!n&&n!=="identity",i=o.headers.get("Content-Length"),d=i&&!r?parseInt(i,10):null,p=le(o.headers.get("Content-Type"));return{supportsRange:s,totalBytes:d,mimeType:p}}catch{return{supportsRange:!1,totalBytes:null,mimeType:null}}}function le(e){return e&&e.split(";")[0].trim()||null}function ue(e){let t=e.reduce((n,r)=>n+r.byteLength,0),o=new Uint8Array(t),s=0;for(let n of e)o.set(n,s),s+=n.byteLength;return o}async function Oe(e){let{id:t,downloadUrl:o,ttl:s}=e,n=new AbortController;b.set(t,n);let r=await w(a.DOWNLOAD_QUEUE,t),i=r?.retryCount??0;for(;i<=ae;)try{await g(t,{status:u.IN_PROGRESS,lastAttemptAt:Date.now(),retryCount:i,errorMessage:null}),f("status",{id:t,status:u.IN_PROGRESS}),r=await w(a.DOWNLOAD_QUEUE,t);let d=r?.byteOffset??0,p=!1,m=r?.totalBytes??e.totalBytes??null,E=e.mimeType??null;if(d===0){let R=await Se(o,n.signal);p=R.supportsRange,R.totalBytes&&(m=R.totalBytes,await g(t,{totalBytes:m})),!E&&R.mimeType&&(E=R.mimeType)}else p=!0;let A=p&&m&&m>ge,l,c=null;if(A)l=await Ue(t,o,d,m,n.signal);else{let R=await he(t,o,n.signal);l=R.buffer,c=R.mimeType}let S=E??c??"application/octet-stream",O=new Blob([l],{type:S}),k=Date.now(),pe=V(k,s);await g(t,{status:u.COMPLETE,blob:O,bytesDownloaded:l.byteLength,byteOffset:l.byteLength,completedAt:k,expiresAt:pe,errorMessage:null,deferredReason:null}),f("complete",{id:t,mimeType:S}),b.delete(t);return}catch(d){if(d.name==="AbortError"){await g(t,{status:u.PAUSED}),f("status",{id:t,status:u.PAUSED}),b.delete(t);return}if(i++,i>ae){await g(t,{status:u.FAILED,retryCount:i,errorMessage:d.message}),f("error",{id:t,error:d,retryCount:i}),b.delete(t);return}let p=Re(i-1);console.warn(`[offline-data-manager] "${t}" failed (attempt ${i}), retrying in ${p}ms:`,d.message),f("error",{id:t,error:d,retryCount:i,willRetry:!0}),await g(t,{status:u.PENDING,retryCount:i,errorMessage:d.message}),await Ae(p)}}async function he(e,t,o){let s=await fetch(t,{signal:o});if(!s.ok)throw new Error(`HTTP ${s.status} ${s.statusText}`);let n=s.headers.get("Content-Encoding"),r=!!n&&n!=="identity",i=s.headers.get("Content-Length"),d=i&&!r?parseInt(i,10):null,p=le(s.headers.get("Content-Type")),m=s.body.getReader(),E=[],A=0;for(;;){let{done:l,value:c}=await m.read();if(l)break;E.push(c),A+=c.byteLength,await g(e,{bytesDownloaded:A,totalBytes:d}),f("progress",{id:e,bytesDownloaded:A,totalBytes:d,percent:d?Math.round(A/d*100):null})}return{buffer:ue(E),mimeType:p}}async function Ue(e,t,o,s,n){let r=o,i=[],d=o;for(;r<s;){let p=Math.min(r+ye-1,s-1),m=await fetch(t,{signal:n,headers:{Range:`bytes=${r}-${p}`}});if(!m.ok&&m.status!==206)throw new Error(`HTTP ${m.status} on Range bytes=${r}-${p}`);let E=new Uint8Array(await m.arrayBuffer());i.push(E),r+=E.byteLength,d+=E.byteLength,await g(e,{bytesDownloaded:d,byteOffset:r}),f("progress",{id:e,bytesDownloaded:d,totalBytes:s,percent:Math.round(d/s*100)})}return ue(i)}async function M({concurrency:e=De,resumeOnly:t=!1,retryFailed:o=!1}={}){if(ie={concurrency:e,resumeOnly:t,retryFailed:o},!T()){let l=await y(a.DOWNLOAD_QUEUE);for(let c of l)c.status===u.IN_PROGRESS&&(b.get(c.id)?.abort(),b.delete(c.id),await g(c.id,{status:u.PAUSED,deferredReason:"network-offline"}));f("connectivity",{online:!1});return}if(await J(),o){let l=await y(a.DOWNLOAD_QUEUE);for(let c of l)c.status===u.FAILED&&await g(c.id,{status:u.PENDING,retryCount:0,errorMessage:null})}let[s,n]=await Promise.all([y(a.REGISTRY),y(a.DOWNLOAD_QUEUE)]),r=new Map(s.map(l=>[l.id,l])),i=t?[u.IN_PROGRESS,u.PAUSED]:[u.PENDING,u.IN_PROGRESS,u.PAUSED,u.DEFERRED,u.EXPIRED],p=[...n.filter(l=>i.includes(l.status)).sort((l,c)=>{let S=r.get(l.id)?.priority??10,O=r.get(c.id)?.priority??10;return S-O})],m=new Set;function E(){if(p.length===0)return;let l=p.shift(),c=r.get(l.id);if(!c)return;let S=(async()=>{let O=c.totalBytes??l.totalBytes??0;if(O>0&&!await H(O)){await g(l.id,{status:u.DEFERRED,deferredReason:"insufficient-storage"}),f("deferred",{id:l.id,reason:"insufficient-storage"});return}await Oe(c)})().finally(()=>{m.delete(S),E()});m.add(S)}let A=Math.min(e,p.length);for(let l=0;l<A;l++)E();await new Promise(l=>{let c=setInterval(()=>{m.size===0&&p.length===0&&(clearInterval(c),l())},100)})}async function B(e){b.get(e)?.abort(),b.delete(e)}async function v(){for(let[e,t]of b)t.abort(),b.delete(e)}async function de(){await M({resumeOnly:!0})}function ce(){se({pauseAll:v,resumeAll:()=>M(ie)})}async function xe(e){let t=await w(a.DOWNLOAD_QUEUE,e);t&&await D(a.DOWNLOAD_QUEUE,{...t,status:u.PENDING,blob:null,bytesDownloaded:0,byteOffset:0,retryCount:0,errorMessage:null,deferredReason:null,completedAt:null,expiresAt:null})}async function Y(e,{removeRegistry:t=!1}={}){let o=await w(a.REGISTRY,e);if(!o)throw new Error(`deleteFile: No registered file with id "${e}".`);await B(e);let s=t||!o.protected;return s?(await h(a.REGISTRY,e),await h(a.DOWNLOAD_QUEUE,e)):await xe(e),f("deleted",{id:e,registryRemoved:s}),{id:e,registryRemoved:s}}async function fe({removeRegistry:e=!1}={}){await v();let t=await y(a.REGISTRY);return Promise.all(t.map(o=>Y(o.id,{removeRegistry:e})))}async function Te(e){let[t,o]=await Promise.all([w(a.REGISTRY,e),w(a.DOWNLOAD_QUEUE,e)]);if(!t)throw new Error(`retrieve: No registered file with id "${e}".`);if(!C.has(o?.status)||!o?.blob)throw new Error(`retrieve: File "${e}" has no data yet (status: ${o?.status??"unknown"}).`);return o.blob}var ve={registerFile:Q,registerFiles:Z,downloadFiles:M,abortDownload:B,abortAllDownloads:v,resumeInterruptedDownloads:de,startMonitoring:ce,stopMonitoring:W,isOnline:T,isMonitoring:$,retrieve:Te,view:ee,getStatus:te,isReady:oe,delete:Y,deleteAll:fe,on:G,off:L,once:j,getStorageEstimate:x,requestPersistentStorage:X,isPersistentStorage:z},st=ve;export{v as abortAllDownloads,B as abortDownload,st as default,fe as deleteAllFiles,Y as deleteFile,M as downloadFiles,f as emit,te as getStatus,x as getStorageEstimate,$ as isMonitoring,T as isOnline,z as isPersistentStorage,oe as isReady,L as off,G as on,j as once,Q as registerFile,Z as registerFiles,X as requestPersistentStorage,de as resumeInterruptedDownloads,Te as retrieve,ce as startMonitoring,W as stopMonitoring,ee as view};
