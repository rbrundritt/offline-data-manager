var z="offline-data-manager",V=1,L=null,s={REGISTRY:"registry",DOWNLOAD_QUEUE:"downloadQueue"};async function Z(e,t){z=e??"offline-data-manager",V=t??1}async function U(){return L||(L=await new Promise((e,t)=>{let r=indexedDB.open(z,V);r.onupgradeneeded=a=>{let n=a.target.result;if(!n.objectStoreNames.contains(s.REGISTRY)){let o=n.createObjectStore(s.REGISTRY,{keyPath:"id"});o.createIndex("protected","protected",{unique:!1}),o.createIndex("priority","priority",{unique:!1})}if(!n.objectStoreNames.contains(s.DOWNLOAD_QUEUE)){let o=n.createObjectStore(s.DOWNLOAD_QUEUE,{keyPath:"id"});o.createIndex("status","status",{unique:!1}),o.createIndex("priority","priority",{unique:!1})}},r.onsuccess=()=>e(r.result),r.onerror=()=>t(r.error)}),L)}async function p(e,t){let r=await U();return new Promise((a,n)=>{let o=r.transaction(e,"readonly").objectStore(e).get(t);o.onsuccess=()=>a(o.result),o.onerror=()=>n(o.error)})}async function E(e){let t=await U();return new Promise((r,a)=>{let n=t.transaction(e,"readonly").objectStore(e).getAll();n.onsuccess=()=>r(n.result),n.onerror=()=>a(n.error)})}async function N(e){let t=await U();return new Promise((r,a)=>{let n=t.transaction(e,"readonly").objectStore(e).getAllKeys();n.onsuccess=()=>r(n.result),n.onerror=()=>a(n.error)})}async function y(e,t){let r=await U();return new Promise((a,n)=>{let o=r.transaction(e,"readwrite").objectStore(e).put(t);o.onsuccess=()=>a(),o.onerror=()=>n(o.error),o.onerror=()=>n(o.error)})}async function S(e,t){let r=await U();return new Promise((a,n)=>{let o=r.transaction(e,"readwrite").objectStore(e).delete(t);o.onsuccess=()=>a(),o.onerror=()=>n(o.error)})}var T=new Map;function C(e,t){return T.has(e)||T.set(e,new Set),T.get(e).add(t),()=>_(e,t)}function _(e,t){T.get(e)?.delete(t)}function u(e,t){T.get(e)?.forEach(r=>{try{r(t)}catch(a){console.error(`[offline-data-manager] Error in "${e}" listener:`,a)}})}function J(e,t){let r=a=>{t(a),_(e,r)};C(e,r)}async function I(){if(!navigator?.storage?.estimate)return{usage:0,quota:1/0,available:1/0};let{usage:e=0,quota:t=1/0}=await navigator.storage.estimate();return{usage:e,quota:t,available:t-e}}async function ee(e){let{available:t,quota:r}=await I();return t-r*.1>=e}async function te(){return navigator?.storage?.persist?navigator.storage.persist():!1}async function re(){return navigator?.storage?.persisted?navigator.storage.persisted():!1}function P(e){return e===1/0?"\u221E":e<1024?`${e} B`:e<1024**2?`${(e/1024).toFixed(1)} KB`:e<1024**3?`${(e/1024**2).toFixed(1)} MB`:`${(e/1024**3).toFixed(2)} GB`}var F=null,q=null,M=!1;function oe(){u("connectivity",{online:!1}),F?.()}function ne(){u("connectivity",{online:!0}),q?.()}function ae({pauseAll:e,resumeAll:t}){M||(F=e,q=t,window.addEventListener("offline",oe),window.addEventListener("online",ne),M=!0)}function W(){window.removeEventListener("offline",oe),window.removeEventListener("online",ne),F=null,q=null,M=!1}function v(){return navigator.onLine??!0}function $(){return M}var Se=2*1024*1024,he=5*1024*1024,Oe=2,se=5,xe=1e3,g=new Map,b=!1,G=null;function ie(){return new Promise(e=>{G=e})}function h(){if(G){let e=G;G=null,e()}}var Ue=e=>new Promise(t=>setTimeout(t,e)),Te=e=>xe*Math.pow(2,e);async function m(e,t){let r=await p(s.DOWNLOAD_QUEUE,e);r&&await y(s.DOWNLOAD_QUEUE,{...r,...t})}async function Ie(e,t){try{let r=await fetch(e,{method:"HEAD",signal:t}),a=r.headers.get("Accept-Ranges")==="bytes",n=r.headers.get("Content-Encoding"),o=!!n&&n!=="identity",i=r.headers.get("Content-Length"),l=i&&!o?parseInt(i,10):null,c=le(r.headers.get("Content-Type"));return{supportsRange:a,totalBytes:l,mimeType:c}}catch{return{supportsRange:!1,totalBytes:null,mimeType:null}}}function le(e){return e&&e.split(";")[0].trim()||null}function ue(e){let t=e.reduce((n,o)=>n+o.byteLength,0),r=new Uint8Array(t),a=0;for(let n of e)r.set(n,a),a+=n.byteLength;return r}async function ve(e){let{id:t,downloadUrl:r,ttl:a}=e,n=new AbortController;g.set(t,n);let o=await p(s.DOWNLOAD_QUEUE,t),i=o?.retryCount??0;for(;i<=se;)try{await m(t,{status:d.IN_PROGRESS,lastAttemptAt:Date.now(),retryCount:i,errorMessage:null}),u("status",{id:t,status:d.IN_PROGRESS}),o=await p(s.DOWNLOAD_QUEUE,t);let l=o?.byteOffset??0,c=!1,f=o?.totalBytes??e.totalBytes??null,w=e.mimeType??null;if(l===0){let R=await Ie(r,n.signal);c=R.supportsRange,R.totalBytes&&(f=R.totalBytes,await m(t,{totalBytes:f})),!w&&R.mimeType&&(w=R.mimeType)}else c=!0;let D=c&&f&&f>he,A,x=null;if(D)A=await Ne(t,r,l,f,n.signal);else{let R=await Le(t,r,n.signal);A=R.uint8,x=R.mimeType}let X=w??x??"application/octet-stream",Q=A.buffer,K=Date.now(),be=we(K,a);await m(t,{status:d.COMPLETE,data:Q,mimeType:X,bytesDownloaded:Q.byteLength,byteOffset:Q.byteLength,completedAt:K,expiresAt:be,errorMessage:null,deferredReason:null}),u("complete",{id:t,mimeType:X}),g.delete(t);return}catch(l){if(l?.name==="QuotaExceededError"){await Y(),await m(t,{status:d.DEFERRED,deferredReason:"insufficient-storage"}),u("error",{id:t,reason:"insufficient-storage",willRetry:!1});return}else if(l?.name==="AbortError"){await m(t,{status:d.PAUSED}),u("status",{id:t,status:d.PAUSED}),g.delete(t);return}if(i++,i>se){await m(t,{status:d.FAILED,retryCount:i,errorMessage:l.message}),u("error",{id:t,error:l,retryCount:i}),g.delete(t);return}let c=Te(i-1);console.warn(`[offline-data-manager] "${t}" failed (attempt ${i}), retrying in ${c}ms:`,l.message),u("error",{id:t,error:l,retryCount:i,willRetry:!0}),await m(t,{status:d.PENDING,retryCount:i,errorMessage:l.message}),await Ue(c)}}async function Le(e,t,r){let a=await fetch(t,{signal:r});if(!a.ok)throw new Error(`HTTP ${a.status} ${a.statusText}`);let n=a.headers.get("Content-Encoding"),o=!!n&&n!=="identity",i=a.headers.get("Content-Length"),l=i&&!o?parseInt(i,10):null,c=le(a.headers.get("Content-Type")),f=a.body.getReader(),w=[],D=0;for(;;){let{done:A,value:x}=await f.read();if(A)break;w.push(x),D+=x.byteLength,await m(e,{bytesDownloaded:D,totalBytes:l}),u("progress",{id:e,bytesDownloaded:D,totalBytes:l,percent:l?Math.round(D/l*100):null})}return{uint8:ue(w),mimeType:c}}async function Ne(e,t,r,a,n){let o=r,i=[],l=r;for(;o<a;){let c=Math.min(o+Se-1,a-1),f=await fetch(t,{signal:n,headers:{Range:`bytes=${o}-${c}`}});if(!f.ok&&f.status!==206)throw new Error(`HTTP ${f.status} on Range bytes=${o}-${c}`);let w=new Uint8Array(await f.arrayBuffer());i.push(w),o+=w.byteLength,l+=w.byteLength,await m(e,{bytesDownloaded:l,byteOffset:o}),u("progress",{id:e,bytesDownloaded:l,totalBytes:a,percent:Math.round(l/a*100)})}return ue(i)}async function _e(e){await me();let[t,r]=await Promise.all([E(s.REGISTRY),E(s.DOWNLOAD_QUEUE)]),a=new Map(t.map(l=>[l.id,l])),n=r.filter(l=>[d.PENDING,d.IN_PROGRESS,d.PAUSED,d.DEFERRED,d.EXPIRED].includes(l.status)).sort((l,c)=>(a.get(l.id)?.priority??10)-(a.get(c.id)?.priority??10));if(n.length===0)return;let o=[...n],i=new Set;await new Promise(l=>{function c(){if(!b){l();return}if(o.length===0){i.size===0&&l();return}if(i.size>=e)return;let f=o.shift(),w=a.get(f.id);if(!w){c();return}let D=(async()=>{let A=w.totalBytes??f.totalBytes??0;if(A>0&&!await ee(A)){await m(f.id,{status:d.DEFERRED,deferredReason:"insufficient-storage"}),u("deferred",{id:f.id,reason:"insufficient-storage"});return}await ve(w)})().finally(()=>{i.delete(D),c()});i.add(D),c()}c()})}function de({concurrency:e=Oe}={}){b||(b=!0,(async()=>{for(;b;){if(!v()){let t=await E(s.DOWNLOAD_QUEUE);for(let r of t)r.status===d.IN_PROGRESS&&(g.get(r.id)?.abort(),g.delete(r.id),await m(r.id,{status:d.PAUSED,deferredReason:"network-offline"}));u("connectivity",{online:!1}),await ie();continue}await _e(e),b&&await ie()}})())}async function Y(){b=!1,h(),await O(),u("stopped",{})}async function ce(){let e=await E(s.DOWNLOAD_QUEUE);for(let t of e)t.status===d.FAILED&&await m(t.id,{status:d.PENDING,retryCount:0,errorMessage:null});h()}function fe(){return b}async function B(e){g.get(e)?.abort(),g.delete(e)}async function O(){for(let[e,t]of g)t.abort(),g.delete(e)}function pe(){ae({pauseAll:O,resumeAll:h})}var d={PENDING:"pending",IN_PROGRESS:"in-progress",PAUSED:"paused",COMPLETE:"complete",EXPIRED:"expired",FAILED:"failed",DEFERRED:"deferred"},k=new Set([d.COMPLETE,d.EXPIRED]);function Pe(e){if(!e||typeof e!="object")throw new Error("Registry entry must be an object.");if(!e.id||typeof e.id!="string")throw new Error('Registry entry must have a string "id".');if(!e.downloadUrl||typeof e.downloadUrl!="string")throw new Error(`Entry "${e.id}" must have a string "downloadUrl".`);if(e.mimeType!==void 0&&e.mimeType!==null&&typeof e.mimeType!="string")throw new Error(`Entry "${e.id}" mimeType must be a string or omitted.`);if(typeof e.version!="number"||!Number.isInteger(e.version)||e.version<0)throw new Error(`Entry "${e.id}" version must be a non-negative integer.`);if(e.ttl!==void 0&&(typeof e.ttl!="number"||e.ttl<0))throw new Error(`Entry "${e.id}" ttl must be a non-negative number (seconds).`)}function ye(e){return{id:e,status:d.PENDING,data:null,bytesDownloaded:0,totalBytes:null,byteOffset:0,retryCount:0,lastAttemptAt:null,errorMessage:null,deferredReason:null,completedAt:null,expiresAt:null}}function we(e,t){return t?e+t*1e3:null}function Me(e){return e?Date.now()>=e:!1}async function j(e){try{Pe(e);let t=Date.now(),r=await p(s.REGISTRY,e.id),a=await p(s.DOWNLOAD_QUEUE,e.id),n={id:e.id,downloadUrl:e.downloadUrl,mimeType:e.mimeType??null,version:e.version,protected:e.protected??!1,priority:e.priority??10,ttl:e.ttl??0,totalBytes:e.totalBytes??null,metadata:e.metadata??{},registeredAt:r?.registeredAt??t,updatedAt:t};if(r){if(e.version>r.version){await y(s.REGISTRY,n);let o=a?{...a,status:d.PENDING,bytesDownloaded:0,byteOffset:0,retryCount:0,errorMessage:null,deferredReason:null,completedAt:null,expiresAt:null}:ye(e.id);await y(s.DOWNLOAD_QUEUE,o),u("registered",{id:e.id,reason:"version-updated"}),h()}return}await y(s.REGISTRY,n),await y(s.DOWNLOAD_QUEUE,ye(e.id)),u("registered",{id:e.id,reason:"new"}),h()}catch(t){if(t?.name==="QuotaExceededError"){u("error",{id,reason:"insufficient-storage",willRetry:!1});return}else u("error",{id,reason:t?.message??t,willRetry:!1})}}async function Ee(e){if(!Array.isArray(e))throw new Error("registerFiles expects an array.");let t=new Set(e.map(n=>n.id)),r=await E(s.REGISTRY),a=[];for(let n of r)!t.has(n.id)&&!n.protected&&(await S(s.REGISTRY,n.id),await S(s.DOWNLOAD_QUEUE,n.id),a.push(n.id),u("deleted",{id:n.id,registryRemoved:!0}));for(let n of e)await j(n);return{registered:e.map(n=>n.id),removed:a}}async function Ge(e,t){try{if(e&&t){let r=await p(s.REGISTRY,entry.id);r&&(r.metadata={...r.metadata??{},...t},await y(s.REGISTRY,r))}}catch(r){if(r?.name==="QuotaExceededError"){u("error",{id:e,reason:"insufficient-storage",willRetry:!1});return}else u("error",{id:e,reason:r?.message??r,willRetry:!1})}}async function me(){let e=await E(s.DOWNLOAD_QUEUE),t=[];for(let r of e)r.status===d.COMPLETE&&Me(r.expiresAt)&&(await y(s.DOWNLOAD_QUEUE,{...r,status:d.EXPIRED}),t.push(r.id),u("expired",{id:r.id}));return t}async function ge(){let[e,t,r]=await Promise.all([E(s.REGISTRY),E(s.DOWNLOAD_QUEUE),I()]),a=new Map(t.map(o=>[o.id,o]));return{items:e.map(o=>{let i=a.get(o.id)??null;return{id:o.id,downloadUrl:o.downloadUrl,mimeType:o.mimeType,version:o.version,protected:o.protected,priority:o.priority,ttl:o.ttl,totalBytes:o.totalBytes,metadata:o.metadata,registeredAt:o.registeredAt,updatedAt:o.updatedAt,downloadStatus:i?.status??null,bytesDownloaded:i?.bytesDownloaded??0,storedBytes:i?.data?.length??null,progress:i?.totalBytes&&i?.bytesDownloaded?Math.round(i.bytesDownloaded/i.totalBytes*100):null,retryCount:i?.retryCount??0,lastAttemptAt:i?.lastAttemptAt??null,errorMessage:i?.errorMessage??null,deferredReason:i?.deferredReason??null,completedAt:i?.completedAt??null,expiresAt:i?.expiresAt??null}}).sort((o,i)=>o.priority-i.priority),storage:{usageBytes:r.usage,quotaBytes:r.quota,availableBytes:r.available,usageFormatted:P(r.usage),quotaFormatted:P(r.quota),availableFormatted:P(r.available)}}}async function De(e){let[t,r]=await Promise.all([p(s.REGISTRY,e),p(s.DOWNLOAD_QUEUE,e)]);return t?{id:t.id,downloadUrl:t.downloadUrl,mimeType:t.mimeType??null,version:t.version,protected:t.protected,priority:t.priority,ttl:t.ttl,totalBytes:t.totalBytes,metadata:t.metadata,registeredAt:t.registeredAt,updatedAt:t.updatedAt,downloadStatus:r?.status??null,bytesDownloaded:r?.bytesDownloaded??0,storedBytes:r?.data?.length??null,progress:r?.totalBytes&&r?.bytesDownloaded?Math.round(r.bytesDownloaded/r.totalBytes*100):null,retryCount:r?.retryCount??0,lastAttemptAt:r?.lastAttemptAt??null,errorMessage:r?.errorMessage??null,deferredReason:r?.deferredReason??null,completedAt:r?.completedAt??null,expiresAt:r?.expiresAt??null}:null}async function Ae(e){let t=await p(s.DOWNLOAD_QUEUE,e);return k.has(t?.status)}async function Be(e){let t=await p(s.DOWNLOAD_QUEUE,e);t&&await y(s.DOWNLOAD_QUEUE,{...t,status:d.PENDING,data:null,bytesDownloaded:0,byteOffset:0,retryCount:0,errorMessage:null,deferredReason:null,completedAt:null,expiresAt:null})}async function H(e,{removeProtected:t=!1}={}){let r=await p(s.REGISTRY,e);if(!r)throw new Error(`deleteFile: No registered file with id "${e}".`);await B(e);let a=t||!r.protected;return a?(await S(s.REGISTRY,e),await S(s.DOWNLOAD_QUEUE,e)):await Be(e),u("deleted",{id:e,registryRemoved:a}),{id:e,registryRemoved:a}}async function Re({removeProtected:e=!1}={}){await O();let t=await N(s.REGISTRY);return Promise.all(t.map(r=>H(r,{removeProtected:e})))}async function Qe(e){let[t,r]=await Promise.all([p(s.REGISTRY,e),p(s.DOWNLOAD_QUEUE,e)]);if(!t)throw new Error(`retrieve: No registered file with id "${e}".`);if(!k.has(r?.status)||!r?.data)throw new Error(`retrieve: File "${e}" has no data yet (status: ${r?.status??"unknown"}).`);return{data:r.data,mimeType:r.mimeType}}var Ce={setDBInfo:Z,dbGetAllIds:N,registerFile:j,registerFiles:Ee,startDownloads:de,stopDownloads:Y,retryFailed:ce,isDownloading:fe,abortDownload:B,abortAllDownloads:O,startMonitoring:pe,stopMonitoring:W,isOnline:v,isMonitoring:$,retrieve:Qe,getAllStatus:ge,getStatus:De,isReady:Ae,delete:H,deleteAll:Re,on:C,off:_,once:J,getStorageEstimate:I,requestPersistentStorage:te,isPersistentStorage:re},yt=Ce;export{O as abortAllDownloads,B as abortDownload,yt as default,Re as deleteAllFiles,H as deleteFile,u as emit,ge as getAllStatus,De as getStatus,I as getStorageEstimate,fe as isDownloading,$ as isMonitoring,v as isOnline,re as isPersistentStorage,Ae as isReady,_ as off,C as on,J as once,j as registerFile,Ee as registerFiles,te as requestPersistentStorage,Qe as retrieve,ce as retryFailed,de as startDownloads,pe as startMonitoring,Y as stopDownloads,W as stopMonitoring,Ge as updateRegistryMetadata};
